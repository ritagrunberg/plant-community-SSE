---
title: "Plant commmunity SSE draft analyses July 2020"
author: "Rita Grunbreg"
date: "6/2/2020"
output: html_document
---

```{r setup,  results='hide', message=FALSE, warning=FALSE}
rm(list = ls())  # clear Rs brain 
# load packages 
library(readr)   # read csv file
library(tidyr)   # tidying data
library(dplyr)   # manipulating df
library(ggplot2) # graphing
library(ggpubr)  # nice package for figures
library(vegan)   # nmds + most community analyses 
#library(car)     # repeated measures ANOVA and MANOVA 
#library(piecewiseSEM) # SEM
#library(semPlot) # plot SEM
library(hillR)   # hill diversity
library(agricolae)# AUDPS
#library(MASS)    # discriminate function
library(emmeans)
library(lmerTest)
library(afex) #repeated measures anova + effect sizes 
#library(multcomp)
#library(DescTools)
#library(semEff)  #bootstrap SEM

cent <- read_csv("C:/Users/grunberg/Documents/GitHub/plant-community-SSE/Data/NMDS_centroids_plant_community_SSE_relative_cover.csv")
cent_pa <- read_csv("C:/Users/grunberg/Documents/Mitchell lab/plant_community_analysis/raw_files/NMDS_centroids_plant_community_SSE_PA_3D.csv")
plant_all <- read_csv("C:/Users/grunberg/Documents/GitHub/plant-community-SSE/Data/NMDS_plant_community_SSE_relative_cover.csv")
plant_all_pa <- read_csv("C:/Users/grunberg/Documents/Mitchell lab/plant_community_analysis/raw_files/NMDS_plant_community_SSE_PA_3D.csv")
plant_groups <- read_csv("C:/Users/grunberg/Dropbox/CURRENT_STUFF/plant_cover_analysis/data/plant_groups.csv")
plant_community <- read_csv("C:/Users/grunberg/Dropbox/CURRENT_STUFF/plant_cover_analysis/data/plant_community_fixed_2Dec2019.csv")
plot_treatment <- read_csv("C:/Users/grunberg/Dropbox/CURRENT_STUFF/plot_treatment.csv")
plotbiomass_2017 <- read_csv("C:/Users/grunberg/Dropbox/CURRENT_STUFF/plant_cover_analysis/data/2017PlotBiomass_SSprayExp.csv")
plotbiomass_2018 <- read_csv("C:/Users/grunberg/Dropbox/CURRENT_STUFF/plant_cover_analysis/data/2018PlotBiomass_SSprayExp.csv")
plotbiomass_2019 <- read_csv("C:/Users/grunberg/Dropbox/CURRENT_STUFF/plant_cover_analysis/data/2019PlotBiomass_SSprayExp.csv")
SSE_prevalence_overall <- read_csv("C:/Users/grunberg/Documents/Mitchell lab/plant_community_analysis/raw_files/SSE_prevalence_overall.csv") #overall prevalence 
SSE_prevalence_spp <- read_csv("C:/Users/grunberg/Documents/Mitchell lab/plant_community_analysis/raw_files/SSE_prevalence_spp.csv")
pcoordO <- read_csv("C:/Users/grunberg/Documents/GitHub/plant-community-SSE/Data/plantsp_coordinates_BC_relative_cover.csv")
#prevalence for each parasite spp. 
plant_height_Widener2020 <- read_csv("C:/Users/grunberg/Documents/GitHub/plant-community-SSE/Data/Plant.height.data_Widener2020.csv")
climate_data_durham <- read_csv("C:/Users/grunberg/Documents/GitHub/plant-community-SSE/Data/climate_data_durham.csv")

```

Description of data files

1. cent [NMDS_centroids_plant_community_SSE.csv] centroids from B-C ordination of plants communities
2. cent_pa [NMDS_centroids_plant_community_SSE_PA_3D.csv] centroids from JAC ordination of plants communities
3. plant_all [NMDS_plant_community_SSE.csv] nmds coordinates based on B-C distances between plants communities 
4. plant_all_pa [NMDS_plant_community_SSE_PA_3D..csv] nmds coordinates based on JAC distances between plants communities 
5. plant_groups [plant_groups.csv] data on plant species: origin, group, family, etc
6. plant_community [plant_community_fixed_2Dec2019.csv] plant community matrix from 2017, 2018, 2019; files has been modified based on Rob's feedback 
7. plotbiomass_2017 [2017PlotBiomass_SSprayExp.csv] plot biomass from SSE 
8. plotbiomass_2018 [2018PlotBiomass_SSprayExp.csv] plot biomass from SSE 
9. plotbiomass_2019 [2019PlotBiomass_SSprayExp.csv] plot biomass from SSE 
10. SSE_prevalence_overall [SSE_prevalence_overall.csv] monthly prevalence data - plot level; cross-species prevalence used
11. SSE_prevalence_spp [SSE_prevalence_plot_level.csv] monthly prevalence data - plot level; prevalence for the three focal pathogens used 


```{r set graphic theme}
rita_theme <-  theme_classic(base_size = 15)+
  theme(legend.title = element_text(size=7, face="bold"),
        legend.text = element_text(size=6.5),
        legend.position=c(0.15,0.18),
        axis.line = element_line(colour = 'black', size = 0.75),
        axis.ticks = element_line(colour = "black", size = 0.75),
        axis.text.x = element_text(size=12,  colour = "black"), 
        axis.text.y = element_text(size=12,  colour = "black"), # bold
        axis.title.y = element_text(size=14, colour = "black")
  )
```

Get the 95% quantile for plant max height from data collection by Brooklynn and Rita in the Widener plots Sept 22 2020

```{r quantile height widner}
plant95quant_widener <- plant_height_Widener2020 %>%
  group_by(Species) %>%
  summarise(Max_height_cm =quantile(Max_height_cm, c( .95))) #%>% #get 95% quantile for max height 
 # filter(Max_height_cm > 30) # remove Poa from dataset, not comfortable with ID 

head(plant95quant_widener)
```
Here I am adding row and column to get an idea of spatial blocks. Note that this experiment was not actually blocked and a fully randomized design

Next I calculated total plant cover for each plot and then calculated relative cover for each species

Finally calculated richness and other diversity metrics for each plot 
```{r formatting community data}
#add row and column  = post hoc spatial blocks, 
plot_treatment$row <- rep(1:16, times=1, each=4) # rep 16 rows, one time for 4 treatments
plot_treatment$column <- rep(seq(1:4), times=16) # rep 1:4, adding column effects 
plot_treatment$Plot <- as.factor(plot_treatment$Plot)
plot_treatment$Treat <- as.factor(plot_treatment$Treat)

#lump paspalum spp. ???; rob not sure how he could discriminate between these two species 
#paspalum <- plant_community %>% select(c(Plot, Year, "Paspalum dilatatum", "Paspalum notatum")) %>% drop_na()
#paspalum$Paspalum_sp <- rowSums(paspalum[,3:4])
#paspalum <- paspalum %>% select(Plot, Year, Paspalum_sp) 
#plant_community <- merge(plant_community, paspalum, by =c("Plot", "Year")) # add paspalum sp.
#plant_community <-  subset(plant_community, select = -c(57,59)) # remove paspalum dilatatum and notatum

#merge DFs
plant_community_duex <- merge(plot_treatment, plant_community, by=c('Plot')) 
plant_community_duex$total_cover <- rowSums(plant_community_duex[,8:106]) # total cover includes litter 
plant_community_duex$total_cover

# max total cover
max(plant_community_duex$total_cover)
# min total cover 
min(plant_community_duex$total_cover)
hist(plant_community_duex$total_cover, main='Histogram of total plant cover', xlab="Total cover")

plant_community_duex <- subset(plant_community_duex, select = -c(Litter, X102)) # remove litter not a sp. and random row that got in here 
#plant_community_duex  <- subset(plant_community_duex, select = -c(total_cover)) # remove total_cover

#makes everything relative to total cover; use this for relative abundance data 
relative_cover<-apply(plant_community_duex[,8:106],2, function(x) x/plant_community_duex$total_cover)
total <- rowSums(relative_cover[,1:98]) # checks that this works, so not all plots will add up to 100 because of the litter 
max(total)
min(total)

#new df with relative cover
plant_community_trio <- cbind(plant_community_duex[1:7], relative_cover) 
plant_community_trio <- subset(plant_community_trio, select = -c(total_cover)) # remove total_cover

# add diversity data 
plant_community_diversity <- plant_community_trio %>%
  mutate(sp_rich = hill_taxa(plant_community_trio[8:ncol(plant_community_trio)], 
                             q = 0, MARGIN = 1, base = exp(1)),
         hill_shannon = hill_taxa(plant_community_trio[8:ncol(plant_community_trio)], 
                                  q = 1, MARGIN = 1, base = exp(1)),
         hill_simpson = hill_taxa(plant_community_trio[8:ncol(plant_community_trio)],
                                  q = 2, MARGIN = 1, base = exp(1)) 
         )
#maximum richness within a plot
max(plant_community_diversity$sp_rich)
#minimum richness within a plot 
min(plant_community_diversity$sp_rich)

```

Adding a column that indicates year and log transforming biomass data. Then merge with plant community data

```{r formatting biomass}
biomass_2019 <- plotbiomass_2019 %>%
  mutate(Year = rep("2019"))  %>% 
  group_by(Plot, Year) %>%
  summarise(total_biomass = sum(`Plot.biomass(g/m^2)`)) %>% 
  drop_na()
biomass_2019 <- merge(biomass_2019, plot_treatment, by =c('Plot'))

biomass_2018 <- plotbiomass_2018 %>%  
  group_by(Plot, Year) %>%
  summarise(total_biomass = sum(`Plot.biomass(g/m^2)`))
biomass_2018 <- merge(biomass_2018, plot_treatment, by =c('Plot'))

biomass_2017 <- plotbiomass_2017 %>%  
  group_by(Plot, Year) %>%
  summarise(total_biomass = sum(`Total.Ovendried.weight(g/m^2)`)) 
biomass_2017 <- merge(biomass_2017, plot_treatment, by =c('Plot'))

biomass <- rbind(biomass_2017, biomass_2018, biomass_2019)
biomass <- biomass %>% 
  mutate(log_biomass = log10(total_biomass),
         Year = as.factor(Year)) %>%
  dplyr::select(Plot, Year, total_biomass, log_biomass)

# merge with community data 
plant_community_biomass <- merge(plant_community_diversity, biomass, by = c("Plot", "Year")) 
```
In 2018 plant biomass was separated into categories. Here I did a quick analysis for a supplement. 
```{r sorted biomass}
sorted_biomass_2018 <- plotbiomass_2018 %>%  
  group_by(Plot, Year, Biomass.category) %>%
  summarise(total_biomass = (`Plot.biomass(g/m^2)`))
sorted_biomass_2018 <- merge(sorted_biomass_2018, plot_treatment, by =c('Plot'))

sorted_biomass_2018 %>%
  ggplot()+
  geom_boxplot(aes(x= Treat, y = total_biomass, fill=Biomass.category))+ 
  rita_theme+
  labs(x = "",  y = bquote('log'[10]~' plant biomass (g '~m^-2*')'))+
  scale_fill_manual(values=c('#a6611a','#018571','#f5f5f5','#80cdc1','#dfc27d'))+
  theme(legend.position=c(0.13,0.85))

biomass_wide <- sorted_biomass_2018 %>% 
  spread(Biomass.category, total_biomass)%>%
  rename(monocots = 'Non-fescue monocots', dicots = "Non-woody dicots", woody = "Woody dicots")

#MANOVA on all groups
bio.manova <- manova(cbind(Dead, Fescue, monocots, dicots, woody)~Treat, data=biomass_wide)
summary(bio.manova)

#ANOVA on fescue
fes.bio <- aov(Fescue ~ Treat, data=biomass_wide)
summary(fes.bio)
f.bio_emm <- emmeans(fes.bio , ~ Treat)
pairs(f.bio_emm)
#fescue_biomass <-data.frame(f.bio_emm)

#post hoc groupings for fescue
#C-R-P: C
#Control: A
#CR-P: bc
#CRP: ab

#dead plant biomass
dead.bio <- aov(Dead ~ Treat, data=biomass_wide)
summary(dead.bio)

#non fescue monocots
monocot.bio <- aov(monocots ~ Treat, data=biomass_wide)
summary(monocot.bio)

#non woody dicots
dicot.bio <- aov(dicots ~ Treat, data=biomass_wide)
summary(dicot.bio)

#woody dicots
woody.bio <- aov(woody ~ Treat, data=biomass_wide)
summary(woody.bio)
w.bio_emm <- emmeans(woody.bio , ~ Treat)
pairs(w.bio_emm)

#post hoc groupings for fescue
#C-R-P: ab
#Control: b
#CR-P: b
#CRP: a

dodge <- position_dodge(width = 0.75)

sort_biomass_means <-sorted_biomass_2018 %>%
  group_by(Biomass.category, Treat)%>%
  mutate(mean = mean(total_biomass),
            sd = sd(total_biomass),
            nobs = 16) %>%
  group_by(Biomass.category, Treat)%>%
  mutate(se = sd / sqrt(nobs),
         lower = mean - qt(1 - (0.05 / 2), nobs - 1) * se,
         upper = mean + qt(1 - (0.05 / 2), nobs - 1) * se)

#jpeg(file="sorted_biomass_2018.jpeg", width = 140, height = 90, units = 'mm', res = 300)
ggplot(data=sort_biomass_means, aes(x=Treat, y = mean, fill=Biomass.category))+
  geom_errorbar(aes(ymin=lower, ymax=upper), data=sort_biomass_means, 
                position=dodge, width=0.1) +
  geom_point(aes(x= Treat, y = total_biomass, fill=Biomass.category), pch=21, data = sorted_biomass_2018,
             position=position_jitterdodge(dodge.width=0.75,  jitter.width = 0.05), 
             size=0.8, alpha=0.35)+ 
  geom_point(aes(x=Treat, y =(mean), fill=Biomass.category), size=2.25, pch=21,  position=dodge, data=sort_biomass_means) + 
  rita_theme+
  labs(x = "",  y = bquote('plant biomass (g '~m^-2*')'))+
  scale_fill_manual(values=c('#a6611a','#018571','#f5f5f5','#80cdc1','#dfc27d'))+
  guides(fill=guide_legend("Group",  keywidth=0.12,
                           keyheight=0.12, override.aes = list(shape=21),
                           default.unit="inch"), color= FALSE)+
  annotate("text", x = 0.85, y = 620, label = "c", size=2) +   #fescue
  annotate("text", x = 1.85, y = 1050, label = "a", size=2) +  #fescue
  annotate("text", x = 2.85, y = 700, label = "bc", size=2) +  #fescue
  annotate("text", x = 3.85, y = 1000, label = "ac", size=2) +  #fescue
  
  annotate("text", x = 1.3, y = 100, label = "ab", size=2) +   #fescue
  annotate("text", x = 2.3, y = 50, label = "b", size=2) +  #fescue
  annotate("text", x = 3.3, y = 50, label = "b", size=2) +  #fescue
  annotate("text", x = 4.3, y = 200, label = "a", size=2) +  #fescue
  theme(legend.position=c(0.15,0.85))
#dev.off()
```
The following calculates the cross-species AUDPS for each plot and each year 

```{r parasite AUDPS cross species}
# designate months as a factor; and put in order 
SSE_prevalence_overall$Month = factor(SSE_prevalence_overall$Month, levels = month.name)
# select target parasite species and months 
SSE_prevalence_overall2 <- SSE_prevalence_overall %>% 
  filter(Month %in% c("May", "June" , "July" , "August", "September", "October", "November"))

# list for loop
year_list <- unique(SSE_prevalence_overall2$Year) 
plot_list <- unique(SSE_prevalence_overall2$Plot)
auc_parasite_all <- data.frame()


for(k in year_list){
  for (i in plot_list){

     #   test <- SSE_prevalence_overall %>% 
      #  arrange(Month)%>%
       # filter(Year == "19") %>% 
      #  filter(Plot == "3") %>% 
      #  mutate(time = seq(1:7)) %>% 
       # ungroup() %>%
      #  dplyr::select(time, Month, prevalence_within_plot)
 
      test <- SSE_prevalence_overall2 %>% 
        arrange(Month)%>%
        filter(Year == k) %>% 
        filter(Plot == i) %>% 
        mutate(time = seq(1,181,by=30 )) %>% 
        ungroup() %>%
        dplyr::select(time, Month, prevalence_within_plot)
      
      AUC <- audps(test$prevalence_within_plot, test$time)
      auc_test <- data.frame(k, i,  AUC)
      auc_parasite_all <- rbind(auc_parasite_all, auc_test)

  }
}

col_head <- c("Year", "Plot",  "AUDPS_parasite")
colnames(auc_parasite_all) <- col_head

auc_parasite_all <- merge(plot_treatment, auc_parasite_all, by ="Plot")
head(auc_parasite_all)
#AUC: the area under the curve of population level (e.g., plot-level) infection over time: from May to Nov. 
#rewording to better integrate files 
auc_parasite_all$Year<-gsub("17", "2017", auc_parasite_all$Year)
auc_parasite_all$Year<-gsub("18", "2018", auc_parasite_all$Year)
auc_parasite_all$Year<-gsub("19", "2019", auc_parasite_all$Year)
#write.csv(auc_parasite_all, "audps_parasite_allspp_SSE171819.csv")

auc_parasite <- auc_parasite_all %>% 
  dplyr::select(Plot, Year, AUDPS_parasite) %>%
  mutate(Plot = as.factor(Plot))
#make the df wide to integrate into other files  
head(auc_parasite_all)
plant_community_disease <- merge(plant_community_biomass, auc_parasite, by = c("Plot", "Year")) 
```

Now df has plant community, diversity, biomass and disease data. Adding information on cover of groups 

```{r add group data}
plant_tidy <- plant_community_disease %>% 
  gather (Species, cover, 8:105) %>% 
  left_join(plant_groups, plant_tidy, by = 'Species')

#add column for total cover of each group: grass, forb, woody, legumes  
plant_growth <- plant_tidy  %>% 
 # group_by(Year, Treat, Plot, Group) %>%
  group_by(Year, Treat, Plot, Growth) %>% 
  summarise_at(c("cover"), sum) %>% 
  ungroup()%>%
  mutate(Year = as.factor(Year),
         Treat = as.factor(Treat))

plant_invasive <- plant_tidy  %>% 
 # group_by(Year, Treat, Plot, Group) %>%
  group_by(Year, Treat, Plot, Origin) %>% 
  summarise_at(c("cover"), sum) %>% 
  ungroup()%>%
  mutate(Year = as.factor(Year),
         Treat = as.factor(Treat)) %>%
  spread(Origin, cover) %>% 
  replace(is.na(.), 0)

#covert to wide df
plant_g_wide <- plant_growth %>% 
  spread(Growth, cover) %>% 
  replace(is.na(.), 0)

#put underscore for fescue 
names(plant_community_disease)[names(plant_community_disease) == "Schedonorus arundinaceus"] <- "Schedonorus_arundinaceus"

#integrate with data 
plant_group_etc_one <- merge(plant_community_disease, plant_g_wide, by =c("Plot", "Year", "Treat"))
plant_group_etc <- merge(plant_group_etc_one, plant_invasive, by =c("Plot", "Year", "Treat"))

# charles_list <- plant_tidy %>%
#   group_by(Species) %>% 
#   filter (sum(cover)>0) %>%
#   group_by(Species, Max_height_cm, Origin, Growth) %>%
#   summarise_at(c("cover"), max)
#write.csv(charles_list, 'plant_height_SSE.csv')
```

Get community weighted mean for max plant height

```{r CWM height}
cwm_height <- plant_tidy %>% 
  filter(Max_height_cm >0)%>% # only include sp with height data
  filter(cover >0)%>% # remove sp with zero cover
  group_by(Plot, Year, Treat) %>% # group by treatment * year factors 
  summarise(Height_cwm = weighted.mean(Max_height_cm, cover), # trait * weighted by abundance 
            total_cover = sum(cover)) %>%
  mutate(Year = as.factor(Year))

# cwm_height %>%
#   ggplot()+
#   geom_boxplot(aes(x=Year, y=log10(Height_cwm), fill=Treat))+
#   scale_fill_manual(values=c('#fed976','#a1dab4','#41b6c4','#225ea8'),
#                     guide=guide_legend(override.aes=list(shape=21)), 
#                     labels = c("Never", "Always", "CR->P", "CRP"))+
#   labs(x="",y="max height cwm")+
#   ggtitle("CWM with Poa (estimate 30 cm)")+
#   rita_theme+
#   guides(fill=guide_legend("Treatment",  keywidth=0.12,
#                            keyheight=0.12, override.aes = list(shape=21),
#                            default.unit="inch"), color= FALSE)+
#   theme(legend.title = element_text(size=7, face="bold"),
#         legend.text = element_text(size=6.5))+ 
#   theme(legend.position=c(0.10,0.85))
# 
# cwm_anova <- aov(log10(Height_cwm) ~ Year * Treat + Error(Plot/(Year)), cwm_height)
# summary(cwm_anova)

```

Before we calculated the  AUDPS for all parasite species pooled together (cross-species AUDPS). Here we calculated AUDPS for each of the three focal fungal pathogens 

```{r parasite AUDPS for each species}
# designate months as a factor; and put in order 
SSE_prevalence_spp$Month = factor(SSE_prevalence_spp$Month, levels = month.name)
# select target parasite species and months 
SSE_prevalence_spp2 <- SSE_prevalence_spp %>%
  filter(parasite %in% c("Anthracnose","CRust", "Rhiz")) %>%
  filter(Month %in% c("May", "June" , "July" , "August", "September", "October", "November"))



# list for loop
year_list <- unique(SSE_prevalence_spp2$Year) 
plot_list <- unique(SSE_prevalence_spp2$Plot)
parasite_list <- unique(SSE_prevalence_spp2$parasite)
auc_parasite_spp <- data.frame()


for(k in year_list){
  for (i in plot_list){
    for (j in parasite_list){
    
      #  test <- SSE_prevalence_spp %>% 
      #  arrange(Month)%>%
      #  filter(Year == "19") %>% 
      #  filter(Plot == "3") %>% 
      #  filter(parasite == "Anthracnose") %>% 
      #  mutate(time = seq(1:7)) %>% 
      #  ungroup() %>%
      #  select(time, Month, prev_within_plot)
 
      test <- SSE_prevalence_spp2 %>% 
        arrange(Month)%>%
        filter(Year == k) %>% 
        filter(Plot == i) %>% 
        filter(parasite == j) %>% 
        mutate(time = seq(1,181,by=30 )) %>% 
        ungroup() %>%
        dplyr::select(time, Month, prevalence_among_plants)
      
      AUC <- audps(test$prevalence_among_plants, test$time)
      auc_test <- data.frame(k, i, j, AUC)
      auc_parasite_spp <- rbind(auc_parasite_spp, auc_test)
    }
  }
}

col_head <- c("Year", "Plot", "parasite", "AUDPS_parasite")
colnames(auc_parasite_spp) <- col_head

auc_parasite_spp <- merge(plot_treatment, auc_parasite_spp, by ="Plot")
head(auc_parasite_spp)
#AUC: the area under the curve of population level (e.g., plot-level) infection over time: from May to Nov. 
#rewording to better integrate files 
auc_parasite_spp$parasite<-gsub("CRust", "Rust", auc_parasite_spp$parasite)
auc_parasite_spp$Year<-gsub("17", "2017", auc_parasite_spp$Year)
auc_parasite_spp$Year<-gsub("18", "2018", auc_parasite_spp$Year)
auc_parasite_spp$Year<-gsub("19", "2019", auc_parasite_spp$Year)
#write.csv(auc_parasite_spp, "audps_parasite_all_SSE171819.csv")

#make the df wide to integrate into other files  
auc_wide <- auc_parasite_spp %>% 
  spread(parasite, AUDPS_parasite) %>% 
  replace(is.na(.), 0) %>%
  dplyr::select(Plot, Year, Anthracnose, Rhiz, Rust)

#merge with other df
plant_SSE <- merge(plant_group_etc , auc_wide, by = c("Plot", "Year")) 
```

```{r formatting}
library(gtools)
plant_SSE <- merge(plant_SSE, cwm_height, by = c("Plot", "Year", "Treat"))
plant_SSE <- plant_SSE %>% mutate(Plot = as.factor(Plot), 
                                  Year = as.factor(Year), 
                                  Treat = as.factor(Treat), 
                                  row = as.factor(row), 
                                  column = as.factor(column),
                                  logit_fescue =logit(Schedonorus_arundinaceus, min=0, max=1.00001)
                                  ) 

#write.csv(plant_SSE, "plant_SSE.csv")

hist(plant_SSE$logit_fescue)
hist(plant_SSE$Schedonorus_arundinaceus)
```
```{r stability}
sp_stability <- plant_SSE %>% gather(species, cover, 8:105)%>%
  group_by(species, Treat, Plot) %>%
  summarise(mean_cover = mean(cover),
         sd_cover = sd(cover),
         CV_cover = mean_cover/sd_cover) %>% drop_na()%>%
  group_by(Plot)%>%
  mutate(communityCV = sum(CV_cover))

sp_stability %>% ggplot()+
  #geom_point(aes(x= CV_cover, y = species, fill=Treat),pch =21)+
  geom_boxplot(aes(x= CV_cover, y = species, fill=Treat),pch =21)+
  rita_theme+
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
    guides(fill=guide_legend("Treatment",  keywidth=0.12,
                           keyheight=0.12, override.aes = list(shape=21),
                           default.unit="inch"), color= FALSE)+
  theme(legend.title = element_text(size=7, face="bold"),
        legend.text = element_text(size=6.5),
        legend.position=c(0.85,0.15))

sp_stability %>% ggplot()+
  #geom_point(aes(x= CV_cover, y = species, fill=Treat),pch =21)+
  geom_boxplot(aes(x= Treat, y = communityCV, fill=Treat),pch =21)+
  rita_theme+
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
    guides(fill=FALSE)

sp_stability %>% filter(species == 'Schedonorus_arundinaceus')%>%
  ggplot()+
  #geom_point(aes(x= CV_cover, y = species, fill=Treat),pch =21)+
  geom_boxplot(aes(x= Treat, y = CV_cover, fill=Treat),pch =21)+
  rita_theme+
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
  labs(x="", y ="Fescue temporal stability (CV)")+
  guides(fill=FALSE)#+
 # guides(fill=guide_legend("Treatment",  keywidth=0.12,
  #                         keyheight=0.12, override.aes = list(shape=21),
   #                        default.unit="inch"), color= FALSE)+
  # theme(legend.title = element_text(size=7, face="bold"),
  #       legend.text = element_text(size=6.5),
  #       legend.position=c(0.85,0.15))+ 

fescue.stab <- sp_stability %>%
  filter(species == 'Schedonorus_arundinaceus')%>%
  group_by(Plot, Treat)%>%
  summarise_at(c("CV_cover"), mean)

fes.stab.md <-aov(CV_cover ~ Treat, data=fescue.stab) 
summary(fes.stab.md)
```

```{r checking design}
xtabs(~ Treat + Year, data=plant_SSE)
contr.Sum(4) 
```

```{r plant species, echo=FALSE}
#plant_tidy <- plant_community_disease %>% 
 # gather (Species, cover, 8:105) %>% 
  #left_join(plant_groups, plant_tidy, by = 'Species')

plant_species <- plant_tidy %>% 
  group_by(Group, Origin, Species, Treat, Year) %>%
  summarise_at(c("cover"), funs(mean, var, sd)) %>%
  group_by(Species) %>% 
  filter(sum(mean)>0)

plant_species_year <- plant_tidy %>% 
  group_by(Group, Origin, Species, Year) %>%
  summarise_at(c("cover"), funs(mean, var, sd)) %>%
  mutate(mean = mean) %>%
  group_by(Species) %>% 
  filter(sum(mean)>0)

```

```{r function to check models}
check.model <- function(mod, data) {
  residdf <- dplyr::mutate(data, resids = residuals(mod),
                           fits = fitted(mod))
  fig2 <-ggplot(residdf, aes(x = fits, y = resids)) + 
    geom_point() +
    labs(x = 'Fitted values', y = 'Residuals')+
    geom_hline(yintercept = 0)+
    theme_bw()
  
  fig3 <- ggplot(residdf) + 
    stat_qq(aes(sample = resids)) +
    labs(x = 'Theoretical Quantiles', y = 'Sample Quantiles')+ 
    theme_bw()
  
  fig4 <- ggplot(residdf, aes(x = resids)) + geom_histogram(aes(y=..density..), colour = 'grey50') +
    labs(x = 'Residuals', y = 'Frequency') + scale_y_continuous(expand = c(0, 0)) +
    stat_function(fun = dnorm, color = "red", args = list(mean = mean(residdf$resids),
                                                          sd = sd(residdf$resids)))+ theme_bw()

  ggarrange(fig2, fig3, fig4, ncol = 1)  
  return( ggarrange(fig2, fig3, fig4) )
}
```

To determine the effectiveness of the fungicide treatments on pathogen epidemics we used a repeated-measures MANOVA.  The AUDPS of Anthracnose, Rhizoctonia and Rust were the three response vectors, and fungicide treatment, year, and treatment*year interactions were included as fixed effects and plot nested within year was designated as a mixed effect. 

Univariate ANOVAS were used to examine individual dependent variables contribution to main effects 

First look at cross species AUDPS 
```{r disease_anova}
disease_anova <- aov((AUDPS_parasite) ~ Year * Treat + Error(Plot/(Year)), plant_SSE)
cross_disease_out <- emmeans(disease_anova , ~ Year*Treat) %>% data.frame()
 #pairs(cross_disease_emm)

library(afex)
disease.mod <-aov_car((AUDPS_parasite) ~ Year * Treat + Error(Plot/(Year)), plant_SSE)
check.model(disease.mod, plant_SSE)

 disease_post <-emmeans(disease.mod , ~ Year*Treat)
 multcomp::cld(disease_post, alpha = 0.05, Letters = LETTERS)

```

Visualization of disease and treatment relationship

```{r disease graphic, echo=FALSE}

dodge <- position_dodge(width = 0.70)

#jpeg(file="cross-species_AUDPS.jpeg", width = 90, height = 90, units = 'mm', res = 300)
ggplot(cross_disease_out, aes(x= Year, y = emmean, group=Treat))+
  rita_theme+
  geom_point(aes(x=Year, y = AUDPS_parasite, group=Treat, fill=Treat), 
             pch=21,data =plant_SSE,           
             position=position_jitterdodge(dodge.width=0.70,  jitter.width = 0.20), 
             size=1, alpha=0.35)+
 # geom_errorbar(aes(ymin=mean - std, ymax=mean + std),
  #              position=dodge, width=0.1) +
  geom_errorbar(aes(ymin=lower.CL, ymax=upper.CL), data=cross_disease_out,
                position=dodge, width=0.1) +
  geom_point(aes(x=Year, y =emmean, fill=Treat), 
             pch=21, size=2.5, position=dodge)+
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
  scale_color_manual(values=c('#ffeda0','#a1dab4','#41b6c4','#225ea8')) +
  guides(fill=guide_legend("Treatment",  keywidth=0.12,
                           keyheight=0.12, override.aes = list(shape=21),
                           default.unit="inch"), color= FALSE)+
  theme(legend.title = element_text(size=7, face="bold"),
        legend.text = element_text(size=6.5))+ 
  annotate("text", x = 0.73, y = 160, label = "h", size=2) + #17 never sprayed
  annotate("text", x = 0.90, y = 110, label = "c", size=2) +  #17 always sprayed
  annotate("text", x = 1.10, y = 140, label = "g", size=2) +  #17 cr->p
  annotate("text", x = 1.25, y = 130, label = "de", size=2) +  #17 crp
  
  annotate("text", x = 1.73, y = 160, label = "h", size=2) + #18 never sprayed
  annotate("text", x = 1.90, y = 110, label = "cd", size=2) +  #18 always sprayed
  annotate("text", x = 2.10, y = 140, label = "fg", size=2) +  #18 cr->p
  annotate("text", x = 2.25, y = 130, label = "de", size=2) +  #18 crp
  
  annotate("text", x = 2.73, y = 130, label = "ef", size=2) + #19 never sprayed
  annotate("text", x = 2.90, y = 45, label = "a", size=2) +  #19 always sprayed
  annotate("text", x = 3.10, y = 70, label = "b", size=2) +  #19 cr->p
  annotate("text", x = 3.25, y = 45, label = "a", size=2)+   #19 crp
  guides(color=FALSE)+  
  labs(x="", y="Cross-species AUDPS")
#dev.off()

```

 Year  Treat   emmean   SE  df lower.CL upper.CL .group   
 X2019 Control   16.9 2.64 120     11.6     22.1  A       
 X2019 CRP       21.2 2.64 120     16.0     26.4  A       
 X2019 CR->P     40.9 2.64 120     35.6     46.1   B      
 X2017 Control   81.5 2.64 120     76.3     86.8    C     
 X2018 Control   89.1 2.64 120     83.9     94.3    CD    
 X2018 CRP       99.8 2.64 120     94.6    105.0     DE   
 X2017 CRP      100.9 2.64 120     95.7    106.1     DE   
 X2019 C->R->P  106.8 2.64 120    101.6    112.0      EF  
 X2018 CR->P    117.6 2.64 120    112.4    122.8       FG 
 X2017 CR->P    122.9 2.64 120    117.7    128.1        G 
 X2018 C->R->P  136.4 2.64 120    131.1    141.6         H
 X2017 C->R->P  140.4 2.64 120    135.2    145.6         H

```{r parasite_spp, echo=FALSE}
auc_parasite_all <- plant_SSE %>% 
  gather(parasite, AUDPS_parasite, 121:123) %>% 
  group_by(parasite, Treat, Year) %>%
  mutate(mean = mean(AUDPS_parasite), 
         std = sd(AUDPS_parasite)) %>%
  dplyr::select(Year, Treat, parasite, AUDPS_parasite, mean , std)

dodge <- position_dodge(width = 0.70)

#jpeg(file="AUDPS_SSE_parasite_spp.jpeg", width = 280, height = 120, units = 'mm', res = 300)
ggplot(auc_parasite_all, aes(x= Year, y=AUDPS_parasite, group=Treat)) + 
  rita_theme+  
  geom_point(aes(x=Year, y =(AUDPS_parasite), fill=Treat), size=1, pch=21,alpha=0.25, position=dodge) + 
  geom_errorbar(aes(ymin=mean - std, ymax=mean + std),position=dodge, width=0.1) +
  geom_point(aes(x=Year, y =(mean), fill=Treat), size=2.5, pch=21,  position=dodge) + 
  labs(x="", y="AUDPS")+ #ylim(c(0,4.6))+
  theme(axis.text.x = element_text( angle=90))+
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
  guides(fill=guide_legend("Treatment",  keywidth=0.12,
                           keyheight=0.12, override.aes = list(shape=21),
                           default.unit="inch"), color= FALSE)+
  #guides(fill=FALSE)+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1))+ # add black square panel around graphic
  facet_wrap(~parasite,  scales = 'free')
#dev.off()
```

```{r parasite species effect}
library(multcompView)
collet.mod <- aov_car((Anthracnose) ~ Year * Treat + Error(Plot/(Year)), plant_SSE)
collet.mod
afex_plot(collet.mod, "Year", "Treat")+theme_bw()

 collet.out <- emmeans(collet.mod, ~ Treat * Year) %>% data.frame()# %>% rename()
 #emmeans(collet.mod, ~ Treat * Year, contr = "pairwise")
  #multcomp::cld(collet.out, alpha = 0.05, Letters = LETTERS)
 
 rhiz.mod <- aov_car((Rhiz) ~ Year * Treat + Error(Plot/(Year)), plant_SSE)
 rhiz.mod
 #afex_plot(rhiz.mod, "Year", "Treat")+theme_bw()
 rhiz.out <- emmeans(rhiz.mod, ~ Treat * Year) %>% data.frame()
#multcomp::cld(rhiz.out, alpha = 0.05, Letters = LETTERS)

  rust.mod <- aov_car((Rust) ~ Year * Treat + Error(Plot/(Year)), plant_SSE)
 rust.mod
 #afex_plot(rust.mod, "Year", "Treat")+theme_bw()
 rust.out <- emmeans(rust.mod, ~ Treat * Year) %>% data.frame()
 #multcomp::cld(rust.out, alpha = 0.05, Letters = LETTERS)


```

 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 
```{r collet graphic}
dodge <- position_dodge(width = 0.70)

collet.graph <- collet.out %>% 
  ggplot(aes(x= Year, y = emmean, fill = Treat))+
 # geom_point(aes(x=Year, y = Anthracnose, group=Treat, fill=Treat), 
  #           pch=21,data =plant_SSE,           
   #          position=position_jitterdodge(dodge.width=0.70,  jitter.width = 0.25), 
    #         size=1, alpha=0.35)+
  geom_errorbar(aes(ymax = upper.CL, ymin = lower.CL), 
                  position =dodge, width = 0.1, show.legend = FALSE,  color = "black") +
  geom_point(aes(x= Year, y = emmean, fill = Treat), position=dodge, pch=21, size = 2.5)+ 
  labs(x="", y = "Anthracnose AUDPS")+
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
  guides(fill=guide_legend("Treatment",  keywidth=0.12,
                           keyheight=0.12, override.aes = list(shape=21),
                           default.unit="inch"), color= FALSE)+
  scale_x_discrete(labels=c("X2017" = "2017", "X2018" = "2018", "X2019" = "2019"))+
  annotate("text", x = 0.73, y = 140, label = "fg", size=2) + #17 never sprayed
  annotate("text", x = 0.90, y = 90, label = "c", size=2) +  #17 always sprayed
  annotate("text", x = 1.10, y = 130, label = "fg", size=2) +  #17 cr->p
  annotate("text", x = 1.25, y = 110, label = "d", size=2) +  #17 crp
  
  annotate("text", x = 1.73, y = 140, label = "g", size=2) + #18 never sprayed
  annotate("text", x = 1.90, y = 100, label = "d", size=2) +  #18 always sprayed
  annotate("text", x = 2.10, y = 130, label = "ef", size=2) +  #18 cr->p
  annotate("text", x = 2.25, y = 110, label = "d", size=2) +  #18 crp
  
  annotate("text", x = 2.73, y = 110, label = "de", size=2) + #19 never sprayed
  annotate("text", x = 2.90, y = 30, label = "a", size=2) +  #19 always sprayed
  annotate("text", x = 3.10, y = 50, label = "b", size=2) +  #19 cr->p
  annotate("text", x = 3.25, y = 30, label = "a", size=2)+   #19 crp
  rita_theme

collet.graph
```

Anthracnose

Treat   Year  emmean   SE  df lower.CL upper.CL .group  
 Control X2019   15.7 2.81 124     10.1     21.3  A      
 CRP     X2019   19.2 2.81 124     13.6     24.7  A      
 CR->P   X2019   38.2 2.81 124     32.6     43.7   B     
 Control X2017   76.0 2.81 124     70.4     81.5    C    
 Control X2018   87.8 2.81 124     82.2     93.4     D   
 CRP     X2017   93.9 2.81 124     88.3     99.5     D   
 CRP     X2018   97.2 2.81 124     91.6    102.8     D   
 C->R->P X2019   98.7 2.81 124     93.1    104.2     DE  
 CR->P   X2018  111.8 2.81 124    106.2    117.4      EF 
 CR->P   X2017  115.9 2.81 124    110.3    121.4       FG
 C->R->P X2017  124.4 2.81 124    118.9    130.0       FG
 C->R->P X2018  127.9 2.81 124    122.4    133.5        G
```{r rhiz graph}
rhiz.graph <- rhiz.out %>% 
  ggplot(aes(x= Year, y = emmean, fill = Treat))+
 # geom_point(aes(x=Year, y = Anthracnose, group=Treat, fill=Treat), 
  #           pch=21,data =plant_SSE,           
   #          position=position_jitterdodge(dodge.width=0.70,  jitter.width = 0.25), 
    #         size=1, alpha=0.35)+
  geom_errorbar(aes(ymax = upper.CL, ymin = lower.CL), 
                  position =dodge, width = 0.1, show.legend = FALSE,  color = "black") +
  geom_point(aes(x= Year, y = emmean, fill = Treat), position=dodge, pch=21, size = 2.5)+ 
  labs(x="", y = "Rhizoctonia AUDPS")+
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
  guides(fill=guide_legend("Treatment",  keywidth=0.12,
                           keyheight=0.12, override.aes = list(shape=21),
                           default.unit="inch"), color= FALSE)+
  guides(fill=FALSE)+
  scale_x_discrete(labels=c("X2017" = "2017", "X2018" = "2018", "X2019" = "2019"))+
  annotate("text", x = 0.73, y = 35, label = "e", size=2) + #17 never sprayed
  annotate("text", x = 0.90, y = 13, label = "bcd", size=2) +  #17 always sprayed
  annotate("text", x = 1.10, y = 18, label = "d", size=2) +  #17 cr->p
  annotate("text", x = 1.25, y = 15, label = "cd", size=2) +  #17 crp
  
  annotate("text", x = 1.73, y = 17, label = "cd", size=2) + #18 never sprayed
  annotate("text", x = 1.90, y = 5, label = "a", size=2) +  #18 always sprayed
  annotate("text", x = 2.10, y = 10, label = "abc", size=2) +  #18 cr->p
  annotate("text", x = 2.25, y = 8, label = "ab", size=2) +  #18 crp
  
  annotate("text", x = 2.73, y = 15, label = "cd", size=2) + #19 never sprayed
  annotate("text", x = 2.90, y = 6, label = "a", size=2) +  #19 always sprayed
  annotate("text", x = 3.10, y = 7, label = "ab", size=2) +  #19 cr->p
  annotate("text", x = 3.25, y = 6, label = "a", size=2)+   #19 crp
  rita_theme

rhiz.graph
```

RHIZOCTONIA 

 Treat   Year  emmean   SE  df lower.CL upper.CL .group
 Control X2018  0.655 1.34 164    -2.00     3.31  A    
 Control X2019  0.998 1.34 164    -1.65     3.65  A    
 CRP     X2019  1.284 1.34 164    -1.37     3.94  A    
 CR->P   X2019  1.518 1.34 164    -1.13     4.17  AB   
 CRP     X2018  1.578 1.34 164    -1.07     4.23  AB   
 CR->P   X2018  4.778 1.34 164     2.13     7.43  ABC  
 Control X2017  7.725 1.34 164     5.07    10.38   BCD 
 C->R->P X2019  9.836 1.34 164     7.18    12.49    CD 
 CRP     X2017 10.194 1.34 164     7.54    12.85    CD 
 C->R->P X2018 11.046 1.34 164     8.39    13.70    CD 
 CR->P   X2017 12.393 1.34 164     9.74    15.05     D 
 C->R->P X2017 29.382 1.34 164    26.73    32.04      E
```{r rust graph}
rust.graphic <- rust.out %>% 
  ggplot(aes(x= Year, y = emmean, fill = Treat))+
 # geom_point(aes(x=Year, y = Anthracnose, group=Treat, fill=Treat), 
  #           pch=21,data =plant_SSE,           
   #          position=position_jitterdodge(dodge.width=0.70,  jitter.width = 0.25), 
    #         size=1, alpha=0.35)+
  geom_errorbar(aes(ymax = upper.CL, ymin = lower.CL), 
                  position =dodge, width = 0.1, show.legend = FALSE,  color = "black") +
  geom_point(aes(x= Year, y = emmean, fill = Treat), position=dodge, pch=21, size = 2.5)+ 
  labs(x="", y = "Puccinia AUDPS")+
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
  guides(fill=guide_legend("Treatment",  keywidth=0.12,
                           keyheight=0.12, override.aes = list(shape=21),
                           default.unit="inch"), color= FALSE)+
  guides(fill=FALSE)+
  scale_x_discrete(labels=c("X2017" = "2017", "X2018" = "2018", "X2019" = "2019"))+
  annotate("text", x = 0.73, y = 46, label = "f", size=2) + #17 never sprayed
  annotate("text", x = 0.90, y = 11, label = "abc", size=2) +  #17 always sprayed
  annotate("text", x = 1.10, y = 25, label = "d", size=2) +  #17 cr->p
  annotate("text", x = 1.25, y = 12, label = "bc", size=2) +  #17 crp
  
  annotate("text", x = 1.73, y = 46, label = "f", size=2) + #18 never sprayed
  annotate("text", x = 1.90, y = 8, label = "abc", size=2) +  #18 always sprayed
  annotate("text", x = 2.10, y = 35, label = "e", size=2) +  #18 cr->p
  annotate("text", x = 2.25, y = 13, label = "c", size=2) +  #18 crp
  
  annotate("text", x = 2.73, y = 13, label = "c", size=2) + #19 never sprayed
  annotate("text", x = 2.90, y = 5, label = "ab", size=2) +  #19 always sprayed
  annotate("text", x = 3.10, y = 8, label = "abc", size=2) +  #19 cr->p
  annotate("text", x = 3.25, y = 5, label = "a", size=2)+   #19 crp
  rita_theme

rust.graphic
```
 RUST
 
  Treat   Year   emmean  SE  df lower.CL upper.CL .group 
 Control X2019  0.0859 1.4 150   -2.686     2.86  AB    
 CRP     X2019  0.1649 1.4 150   -2.607     2.94  A     
 Control X2018  1.4231 1.4 150   -1.349     4.20  ABC   
 CR->P   X2019  1.9695 1.4 150   -0.802     4.74  ABC   
 Control X2017  4.9514 1.4 150    2.179     7.72  ABC   
 CRP     X2017  6.4445 1.4 150    3.673     9.22   BC   
 C->R->P X2019  6.7530 1.4 150    3.981     9.52    C   
 CRP     X2018  7.1611 1.4 150    4.389     9.93    C   
 CR->P   X2017 19.4919 1.4 150   16.720    22.26     D  
 CR->P   X2018 28.4734 1.4 150   25.701    31.25      E 
 C->R->P X2017 39.8074 1.4 150   37.035    42.58       F
 C->R->P X2018 41.4091 1.4 150   38.637    44.18       F
 
```{r all pathogens}
#jpeg(file="SSE_pathogen_response.jpeg",width = 90, height = 270,  units = 'mm',  res = 300) 
ggarrange(collet.graph, rhiz.graph, rust.graphic,
          ncol=1, nrow=3, 
          labels="AUTO", common.legend = TRUE)
#dev.off()
```


 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Variation in disease exposure may have differential impacts on certain plant species. In particular, fungicide treatments may benefit the dominant grass, tall fescue, through reduced disease burden. We tested this with a rm-ANOVA, evaluating the effects of fungicide over time on fescue cover. 

```{r CWM analysis}
aov_car((Height_cwm) ~ Year * Treat + Error(Plot/(Year)), plant_SSE)
```

```{r fescue model}
#RM anova
fes.md <- aov((Schedonorus_arundinaceus) ~ Treat * Year + Error(Plot/Year), data=plant_SSE)
fes.md1 <-aov_car((Schedonorus_arundinaceus) ~ Year * Treat + Error(Plot/(Year)), plant_SSE)
fes.md2 <-aov_car((logit_fescue) ~ Year * Treat + Error(Plot/(Year)), plant_SSE)
# hist(residuals(fes.md2))
# plot(residuals(fes.md2)~fitted(fes.md2)) 
fes.md1
fes.md2
#check.model(fes.md1, plant_SSE)
check.model(fes.md2, plant_SSE)


#calculate ETA squ.
# fescue.year.eta <-(summary(fes.md)[["Error: Plot:Year"]][[1]]["Year" , "F value"]*summary(fes.md)[["Error: Plot:Year"]][[1]]["Year" , "Df"])/(summary(fes.md)[["Error: Plot:Year"]][[1]]["Year" , "F value"]*summary(fes.md)[["Error: Plot:Year"]][[1]]["Year" , "Df"]+summary(fes.md)[["Error: Plot:Year"]][[1]]["Residuals" , "Df"])
# #fescue.year.eta

#post hoc test 
fes_emm <- emmeans(fes.md, ~ Year)
#pairs(fes_emm)
multcomp::cld(fes_emm, alpha = 0.05, Letters = LETTERS)

fescue_out <- emmeans(fes.md, ~ Year*Treat) %>% data.frame()
```
Fescue cover varied across all years (RM-ANOVA: F2,180 = 43.1, p < 0.0001), but not among fungicide treatments (F3,180 = 2.44, p = 0.07). In 2017, all plots were dominated by tall fescue and cover ranged from 0.56 to 0.99 (mean cover = 0.87, stdev = 0.09). However, fescue cover was lower in 2018 (mean = 0.62, stdev = 0.16), and 2019 (mean = 0.69, stdev = 0.20). 

```{r fescue, echo=FALSE}
#repeated measures anova 
fescue <- plant_SSE %>% 
  group_by(Year, Treat) %>%
  mutate(mean = mean(Schedonorus_arundinaceus*100),
         std = sd(Schedonorus_arundinaceus*100)) %>% 
  ungroup() %>% mutate(Year = as.factor(Year))

fescue_yr <- plant_SSE %>% ungroup()%>%
  group_by(Year) %>%
  summarise(mean = mean(Schedonorus_arundinaceus*100),
         std = sd(Schedonorus_arundinaceus*100))
dodge <- position_dodge(width = 0.70)

#jpeg(file="fescue_cover_SSE.jpeg", width = 120, height = 90, units = 'mm', res = 300)
fescue.graphic <-ggplot(fescue_out, aes(x= Year, y = emmean, group=Treat))+
  rita_theme+
  geom_point(aes(x=Year, y = Schedonorus_arundinaceus, group=Treat, fill=Treat), 
             pch=21,
             data =fescue,
             position=position_jitterdodge(dodge.width=0.70,  jitter.width = 0.20), 
             alpha=0.35, 
             size = 0.8)+
  # geom_errorbar(aes(ymin=mean - std, ymax=mean + std),
  #              position=dodge, width=0.15) +
  geom_errorbar(aes(ymin=lower.CL, ymax=upper.CL),
                position=dodge, width=0.15, data=fescue_out) +
  geom_point(aes(x=Year, y =emmean, fill=Treat), 
             pch=21, size=2.5, position=dodge, data=fescue_out)+
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
  scale_color_manual(values=c('#ffeda0','#a1dab4','#41b6c4','#225ea8')) + 
  guides(fill=guide_legend("Treatment",  keywidth=0.12,
                           keyheight=0.12, override.aes = list(shape=21),
                           default.unit="inch"), color= FALSE)+
   theme(legend.title = element_text(size=7, face="bold"),
        legend.text = element_text(size=6.5))+ 
  annotate("text", x = 1, y = 1.10, label = "C", size=3.5) + #2017
  annotate("text", x = 2, y = 1.00, label = "A", size=3.5) + #2018
  annotate("text", x = 3, y = 1.05, label = "B", size=3.5) +  #2019
  labs(x="", y="Fescue relative cover")
#dev.off()
fescue.graphic

```

We evaluated whether pathogen exclusion, through fungicide application, lowered plant diversity in experimental plots, and how the effects may change across years. Plant diversity was quantified using three metrics: richness, Hill-Shannon diversity (providing a balanced measure of both rare and common species), and Hill-Simpson diversity (emphasizes common species) (Jost 2006). We tested for the effects of fungicide treatment over time on plant biomass and diversity using rm-ANOVAs. All models included fungicide treatment, year, and fungicide treatment*year interactions were as fixed effects and experimental plot nested within year was a mixed effect. Then we evaluated differences among fungicide treatments and years using Tukeyâ€™s post hoc tests.


Pt 1a. Does fungicide treatment affect plant richness?


```{r richness}
#Q1.1: Does richness differ between treatment groups 

# set orthogonal contrasts
options(contrasts = c("contr.sum", "contr.poly"))

#RM-ANOVA
sp_aov <- aov(log10(sp_rich)~Treat *Year + Error(Plot/Year), data=plant_SSE)
sp_aov_3 <-aov_car(log10(sp_rich) ~ Year * Treat + Error(Plot/(Year)), plant_SSE)
sp_aov_3
check.model(sp_aov_3, plant_SSE)
###
#C->R->P Control   CR->P     CRP 
#    "b"     "a"     "a"    "a" 
#spout <- emmeans(sp_aov, ~ Year) 
#multcomp::cld(spout, alpha = 0.05, Letters = LETTERS)
sprichout <- emmeans(sp_aov, ~ Year*Treat) %>% data.frame()
```


In addition to successional changes in plant richness (Year: F = 81.63, p < 0.0001), there were also effects of fungicide treatment on plant richness (Treat: F = 5.23, p = 0.002). Specifically, plots never sprayed with fungicide, that experienced natural levels of disease, had a higher plant richness than plots sprayed with fungicide, that experienced lower levels of disease (Figure below). 

Graphic for plant diversity 

```{r graphic, echo=FALSE}
err_95ci_sp <- aes(ymin=10^(lower.CL), ymax=10^(ymax=upper.CL))
dodge <- position_dodge(width = 0.70)

#jpeg(file="plant_richness_SSE.jpeg",width = 90, height = 90,  units = 'mm',  res = 300) 
richness<-ggplot(data=sprichout, aes(x=Year, y = 10^(emmean), group=Treat))+
  rita_theme+
  geom_point(aes(x=Year, y = (sp_rich), group=Treat, fill=Treat), pch=21, data=plant_SSE, 
             position=position_jitterdodge(dodge.width=0.70,  jitter.width = 0.2), 
             alpha=0.35, size = 0.8)+
  # geom_violin(aes(x=Year, y = sp_rich, group=Treat, fill=Treat),  data=plant_SSE, alpha=0.35)+
  #geom_errorbar(err_stdev_sp, position=dodge, width=0.1) +
  geom_errorbar((err_95ci_sp), position=dodge, width=0.1, data=sprichout) +
   geom_point(aes(x=Year, y = (10^(emmean)), fill=Treat), 
             pch=21, size=2.5, position=dodge, data=sprichout)+
  scale_color_manual(values=c('#ffeda0','#a1dab4','#41b6c4','#225ea8')) + 
  labs(x="", y="Richness") +
  theme(legend.title = element_text(size=7, face="bold"),
        legend.text = element_text(size=6.5))+ 
  theme(legend.position=c(0.18,0.90))+
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
  guides(fill=guide_legend("Treatment",  keywidth=0.12,
                           keyheight=0.12, override.aes = list(shape=21),
                           default.unit="inch"), color= FALSE) +
  guides(fill=FALSE)+
 # ylim(c(1,14))+
  annotate("text", x = 1, y = 9.7, label = "B", size=3.5) + #2017
  annotate("text", x = 2, y = 13.0, label = "C", size=3.5) + #2018
  annotate("text", x = 3, y = 9.5, label = "A", size=3.5) +  #2019
  
  annotate("text", x = 0.73, y = 8.0, label = "b", size=2) + #17 never sprayed
  annotate("text", x = 0.9, y = 7.0, label = "a", size=2) +  #17 always sprayed
  annotate("text", x = 1.10, y = 7.0, label = "a", size=2) +  #17 cr->p
  annotate("text", x = 1.25, y = 7.0, label = "a", size=2) +  #17 crp
  
  annotate("text", x = 1.73, y = 11.2, label = "b", size=2) + #18 never sprayed
  annotate("text", x = 1.9, y = 10.3, label = "a", size=2) +  #18 always sprayed
  annotate("text", x = 2.10, y = 10.3, label = "a", size=2) +  #18 cr->p
  annotate("text", x = 2.25, y = 10.3, label = "a", size=2) +  #18 crp

  annotate("text", x = 2.73, y = 7.8, label = "b", size=2) + #19 never sprayed
  annotate("text", x = 2.9, y = 7.0, label = "a", size=2) +  #19 always sprayed
  annotate("text", x = 3.10, y = 7.0, label = "a", size=2) +  #19 cr->p
  annotate("text", x = 3.25, y = 7.0, label = "b", size=2)
richness
#dev.off()

```

Pt 1. b-c. Does fungicide affect Shannon and Simpson hill diversity 

```{r shannon hill numbers}
shan_aov <- aov_car(hill_shannon ~ Year * Treat + Error(Plot/(Year)), plant_SSE)
summary(shan_aov)
#check.model(shan_aov, plant_SSE)

# shan.year.eta <-(summary(shan_aov)[["Error: Plot:Year"]][[1]]["Year" , "F value"]*summary(shan_aov)[["Error: Plot:Year"]][[1]]["Year" , "Df"])/(summary(shan_aov)[["Error: Plot:Year"]][[1]]["Year" , "F value"]*summary(shan_aov)[["Error: Plot:Year"]][[1]]["Year" , "Df"]+summary(shan_aov)[["Error: Plot:Year"]][[1]]["Residuals" , "Df"])
# shan.year.eta
# 
# shan.treat.eta <-(summary(shan_aov)[["Error: Plot"]][[1]]["Treat" , "F value"]*summary(shan_aov)[["Error: Plot"]][[1]]["Treat" , "Df"])/(summary(shan_aov)[["Error: Plot"]][[1]]["Treat" , "F value"]*summary(shan_aov)[["Error: Plot"]][[1]]["Treat" , "Df"]+summary(shan_aov)[["Error: Plot"]][[1]]["Residuals" , "Df"])
# shan.treat.eta
# 
# shan.interaction.eta <-(summary(shan_aov)[["Error: Plot:Year"]][[1]]["Treat:Year" , "F value"]*summary(shan_aov)[["Error: Plot:Year"]][[1]]["Treat:Year" , "Df"])/(summary(shan_aov)[["Error: Plot:Year"]][[1]]["Treat:Year" , "F value"]*summary(shan_aov)[["Error: Plot:Year"]][[1]]["Treat:Year" , "Df"]+summary(shan_aov)[["Error: Plot:Year"]][[1]]["Residuals" , "Df"])
# shan.interaction.eta

sp_emm2 <- emmeans(shan_aov, ~ Treat * Year) 
  multcomp::cld(sp_emm2, alpha = 0.05, Letters = LETTERS)

#pairs(sp_emm2)
# or for simple comparisons
shannon_out<-data.frame(sp_emm2)
shannon_out$Year<-gsub("X2017", "2017", shannon_out$Year)
shannon_out$Year<-gsub("X2018", "2018", shannon_out$Year)
shannon_out$Year<-gsub("X2019", "2019", shannon_out$Year)

#plot(emmeans(shan_aov, ~ Treat *Year))

######

```

```{r shannon graphics, echo=FALSE}
err_sd_shan <- aes(ymin=lower.CL, ymax=upper.CL)
dodge <- position_dodge(width = 0.70)

shannon <-ggplot(data=shannon_out, aes(x=Year, y = emmean, group=Treat))+
  geom_point(aes(x=Year, y = hill_shannon,  fill=Treat), pch=21, size=0.8, data=plant_SSE, 
             position=position_jitterdodge(dodge.width=0.70,  jitter.width = 0.2), alpha=0.25)+
  geom_errorbar(err_sd_shan, position=dodge, width=0.1, data=shannon_out) +
  geom_point(aes(x=Year, y =emmean, fill=Treat), data=shannon_out, pch=21, size=2.5, position=dodge)+
  rita_theme+
 # scale_color_manual(values=c('#ffeda0','#a1dab4','#41b6c4','#225ea8')) + 
  labs(x="", y="Hill Shannon") +
  theme(legend.title = element_text(size=8.5, face="bold"),
        legend.text = element_text(size=8))+ 
  theme(legend.position=c(0.13,0.85))+
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
  guides(fill=guide_legend("Treatment",  keywidth=0.12,
                           keyheight=0.12, override.aes = list(shape=21),
                           default.unit="inch"), color= FALSE)+
  
  # annotate("text", x = 1, y = 3.2, label = "C", size=4) + #2017
  # annotate("text", x = 2, y = 6, label = "A", size=4) + #2018
  # annotate("text", x = 3, y = 4, label = "B", size=4) +  #2019
  
  annotate("text", x = 0.73, y = 2.6, label = "a", size=2) + #17 never sprayed
  annotate("text", x = 0.90, y = 2.6, label = "a", size=2) +  #17 always sprayed
  annotate("text", x = 1.10, y = 2.6, label = "a", size=2) +  #17 cr->p
  annotate("text", x = 1.25, y = 2.6, label = "a", size=2) +  #17 crp
  
  annotate("text", x = 1.73, y = 5.2, label = "e", size=2) + #18 never sprayed
  annotate("text", x = 1.90, y = 4.3, label = "de", size=2) +  #18 always sprayed
  annotate("text", x = 2.10, y = 3.8, label = "cd", size=2) +  #18 cr->p
  annotate("text", x = 2.25, y = 3.8, label = "cd", size=2) +  #18 crp
  
  annotate("text", x = 2.73, y = 3.5, label = "bc", size=2) + #19 never sprayed
  annotate("text", x = 2.90, y = 2.7, label = "ab", size=2) +  #19 always sprayed
  annotate("text", x = 3.10, y = 3, label = "ab", size=2) +  #19 cr->p
  annotate("text", x = 3.25, y = 3, label = "ab", size=2) +  #19 crp
  guides(fill=FALSE)

shannon
```
 Treat   Year  emmean    SE  df lower.CL upper.CL .group
 Control X2017   1.50 0.137 155     1.23     1.77  A    
 CR->P   X2017   1.54 0.137 155     1.27     1.81  A    
 C->R->P X2017   1.58 0.137 155     1.31     1.85  A    
 CRP     X2017   1.69 0.137 155     1.42     1.96  A 
 
 Control X2019   1.79 0.137 155     1.52     2.06  AB   
 CRP     X2019   1.96 0.137 155     1.69     2.23  AB   
 CR->P   X2019   1.97 0.137 155     1.70     2.24  AB   
 C->R->P X2019   2.38 0.137 155     2.11     2.65   BC
 
 CR->P   X2018   2.61 0.137 155     2.34     2.88    CD 
 CRP     X2018   2.64 0.137 155     2.37     2.91    CD 
 Control X2018   3.02 0.137 155     2.75     3.29     DE
 C->R->P X2018   3.65 0.137 155     3.38     3.92      E

```{r simpson hill numbers}
################################
simp_aov <- aov(hill_simpson~Treat *Year+ Error(Plot/Year) , data=plant_SSE)
#simp_out <-Anova(simp_aov, idata=idata, idesign= Plot/Year)
#summary(simp_aov)
simp_aov.2 <-aov_car(hill_simpson ~ Year * Treat + Error(Plot/(Year)), plant_SSE)
simp_aov.2

# simp.year.eta <-(summary(simp_aov)[["Error: Plot:Year"]][[1]]["Year" , "F value"]*summary(simp_aov)[["Error: Plot:Year"]][[1]]["Year" , "Df"])/(summary(simp_aov)[["Error: Plot:Year"]][[1]]["Year" , "F value"]*summary(simp_aov)[["Error: Plot:Year"]][[1]]["Year" , "Df"]+summary(simp_aov)[["Error: Plot:Year"]][[1]]["Residuals" , "Df"])
# simp.year.eta
# 
# simp.treat.eta <-(summary(simp_aov)[["Error: Plot"]][[1]]["Treat" , "F value"]*summary(simp_aov)[["Error: Plot"]][[1]]["Treat" , "Df"])/(summary(simp_aov)[["Error: Plot"]][[1]]["Treat" , "F value"]*summary(simp_aov)[["Error: Plot"]][[1]]["Treat" , "Df"]+summary(simp_aov)[["Error: Plot"]][[1]]["Residuals" , "Df"])
# simp.treat.eta
# 
# simp.interaction.eta <-(summary(simp_aov)[["Error: Plot:Year"]][[1]]["Treat:Year" , "F value"]*summary(simp_aov)[["Error: Plot:Year"]][[1]]["Treat:Year" , "Df"])/(summary(simp_aov)[["Error: Plot:Year"]][[1]]["Treat:Year" , "F value"]*summary(simp_aov)[["Error: Plot:Year"]][[1]]["Treat:Year" , "Df"]+summary(simp_aov)[["Error: Plot:Year"]][[1]]["Residuals" , "Df"])
# simp.interaction.eta

#post hoc
simpson_out <- emmeans(simp_aov, ~ Treat*Year) %>% data.frame()
#pairs(simp_emm)

 #simp.post <- emmeans(simp_aov.2, ~ Treat * Year) 
 #multcomp::cld(simp.post, alpha = 0.05, Letters = LETTERS)
```
Anova Table (Type 3 tests)

Response: hill_simpson
      Effect           df  MSE          F  ges p.value
1      Treat        3, 60 0.28     2.68 + .067    .055
2       Year 1.75, 104.75 0.14 100.85 *** .441   <.001
3 Treat:Year 5.24, 104.75 0.14    4.19 ** .089    .001
---
Signif. codes:  0 â€˜***â€™ 0.001 â€˜**â€™ 0.01 â€˜*â€™ 0.05 â€˜+â€™ 0.1 â€˜ â€™ 1

Similarly, plant Shannon and Simpson hill diversity were affected by fungicide treatment (Treat: Shannon F = 8.53, p < 0.0001; Simpson F =4.27, p = 0 006). Importantly, when considering Shannon and Simpson diversity, there was a significant interaction between treatment and year (Treat*year: Shannon F =3.91, p = 0.001; Simpson F = 2.95, p = 0.009).

```{r simpson graphic, echo=FALSE}
###############################################
#err_sd_simp <- aes(ymin=mean_simp - sd_simp, ymax=mean_simp + sd_simp)
err_sd_simp <- aes(ymin=lower.CL, ymax=upper.CL)

dodge <- position_dodge(width = 0.70)

simpson<-ggplot(data=simpson_out, aes(x=Year, y = emmean,  group=Treat))+
  geom_point(aes(x=Year, y = hill_simpson,  fill=Treat),
             pch=21, data=plant_SSE, 
             position=position_jitterdodge(dodge.width=0.70,  jitter.width = 0.2), size = 0.8, alpha=0.25)+
  geom_errorbar(err_sd_simp, position=dodge, width=0.1) +
  geom_point(aes(x=Year, y =emmean, fill=Treat), data=simpson_out,
            pch=21, size=2.5, position=dodge)+
  rita_theme+
  # scale_color_manual(values=c('#ffeda0','#a1dab4','#41b6c4','#225ea8')) + 
  labs(x="", y="Hill Simpson") +
  theme(legend.title = element_text(size=8.5, face="bold"),
        legend.text = element_text(size=8))+ 
  theme(legend.position=c(0.13,0.85))+
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
  guides(fill=guide_legend("Treatment",  keywidth=0.12,
                           keyheight=0.12, override.aes = list(shape=21),
                           default.unit="inch"), color= FALSE)+
  
  annotate("text", x = 0.73, y = 1.7, label = "a", size=2) + #17 never sprayed
  annotate("text", x = 0.90, y = 1.7, label = "a", size=2) +  #17 always sprayed
  annotate("text", x = 1.10, y = 1.7, label = "a", size=2) +  #17 cr->p
  annotate("text", x = 1.25, y = 1.8, label = "ab", size=2) +  #17 crp
  
  annotate("text", x = 1.73, y = 3.3, label = "f", size=2) + #18 never sprayed
  annotate("text", x = 1.90, y = 3.0, label = "ef", size=2) +  #18 always sprayed
  annotate("text", x = 2.10, y = 2.5, label = "de", size=2) +  #18 cr->p
  annotate("text", x = 2.25, y = 2.5, label = "cde", size=2) +  #18 crp
  
  annotate("text", x = 2.73, y = 2.4, label = "bcde", size=2) + #19 never sprayed
  annotate("text", x = 2.90, y = 2.0, label = "abc", size=2) +  #19 always sprayed
  annotate("text", x = 3.10, y = 2.3, label = "abcd", size=2) +  #19 cr->p
  annotate("text", x = 3.25, y = 2.3, label = "abcd", size=2) #+  #19 crp
  #guides(fill=FALSE)

simpson
```
 Treat   Year  emmean    SE  df lower.CL upper.CL .group 
 Control X2017   1.23 0.104 153     1.02     1.43  A     
 C->R->P X2017   1.26 0.104 153     1.06     1.47  A     
 CR->P   X2017   1.28 0.104 153     1.07     1.48  A     
 CRP     X2017   1.37 0.104 153     1.16     1.57  AB 
 
 Control X2019   1.44 0.104 153     1.23     1.65  ABC   
 CR->P   X2019   1.64 0.104 153     1.43     1.84  ABCD  
 CRP     X2019   1.64 0.104 153     1.44     1.85  ABCD  
 C->R->P X2019   1.85 0.104 153     1.65     2.06   BCDE 
 
 CRP     X2018   1.90 0.104 153     1.70     2.11    CDE 
 CR->P   X2018   1.98 0.104 153     1.78     2.19     DE 
 Control X2018   2.21 0.104 153     2.00     2.41      EF
 C->R->P X2018   2.52 0.104 153     2.32     2.73       F
 
 
Pt 2. Does fungicide affect plant community biomass 

```{r biomass}
# RM-ANOVA for biomass within plots
# using car package 
bio_aov <- aov(log_biomass~Treat*Year+ Error(Plot/Year), data=plant_SSE)
#summary(bio_aov)
bio_aov.2 <-aov_car(log_biomass ~ Year * Treat + Error(Plot/(Year)), plant_SSE)
check.model(bio_aov.2, plant_SSE)
bio_aov.2
# # post hoc
# bio_emm <- emmeans(bio_aov, ~ Treat)
# pairs(bio_emm)
# bio_emm2 <- emmeans(bio_aov, ~ Year)
# pairs(bio_emm2)
 biomass_post <- emmeans(bio_aov.2, ~ Treat)
 multcomp::cld(biomass_post, alpha = 0.05, Letters = LETTERS)

 biomass_out <- emmeans(bio_aov, ~ Treat*Year) %>% data.frame()
```

Total plant biomass increased over time (p < 0.0001) and was also impacted by fungicide treatment (p < 0.0001). Plots more frequently exposed to fungicide (always sprayed and CRP) had the highest biomass and biomass was lowest in plots never sprayed with fungicide. 

```{r biomass graphic , echo=FALSE}
err_stdev <- aes(ymin=lower.CL, ymax=upper.CL)

dodge <- position_dodge(width = 0.70)

#jpeg(filename="biomass_trt.jpeg", width=90, height=90, units="mm", bg="white", res=300)
biomass <-ggplot(data=biomass_out, aes(x=Year, y = emmean, group=Treat))+
  geom_point(aes(x=Year, y = log_biomass, group=Treat, fill=Treat), pch=21, data=plant_SSE, 
             position=position_jitterdodge(dodge.width=0.70,  jitter.width = 0.2), size = 0.8, alpha=0.25)+
  geom_errorbar(err_stdev, position=dodge, width=0.1) +
  geom_point(aes(x=Year, y =emmean, fill=Treat), 
             pch=21, size=2.5, position=dodge)+
  rita_theme+
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
  guides(color=FALSE, fill=FALSE)+
  labs(x = "",  y = bquote('log'[10]~' plant biomass (g '~m^-2*')'))+
  annotate("text", x = 1, y = 3.30, label = "A", size=4) + #2017
  annotate("text", x = 2, y = 3.30, label = "A", size=4) + #2018
  annotate("text", x = 3, y = 3.4, label = "B", size=4) +  #2019

  annotate("text", x = 0.73, y = 3.0, label = "a", size=2) + #17 never sprayed
  annotate("text", x = 0.9, y = 3.1, label = "c", size=2) +  #17 always sprayed
  annotate("text", x = 1.10, y = 3.05, label = "b", size=2) +  #17 cr->p
  annotate("text", x = 1.25, y = 3.1, label = "c", size=2) +  #17 crp

 annotate("text", x = 1.73, y = 2.95, label = "a", size=2) + #18 never sprayed
annotate("text", x = 1.9, y = 3.15, label = "c", size=2) +  #18 always sprayed
annotate("text", x = 2.10, y = 3.05, label = "b", size=2) +  #18 cr->p
annotate("text", x = 2.25, y = 3.15, label = "c", size=2) +  #18 crp

annotate("text", x = 2.73, y = 3.2, label = "a", size=2) + #19 never sprayed
annotate("text", x = 2.90, y = 3.30, label = "c", size=2) +  #19 always sprayed
annotate("text", x = 3.10, y = 3.2, label = "b", size=2) +  #19 cr->p
annotate("text", x = 3.25, y = 3.30, label = "c", size=2)  #19 crp
#dev.off()

biomass


```

```{r diversity figure}
#jpeg(filename="figure1_plantdiversity.jpeg", width=180, height=180, units="mm", bg="white", res=300)
ggarrange(fescue.graphic, richness, shannon, biomass, 
          ncol=2, nrow=2, labels = 'AUTO', align=c("v"))
#dev.off()
```
While disease was only quantified for tall fescue, other members of the plant community are experiencing different levels of disease. We used a rm-MANOVA to evaluate the effects of fungicide treatments on the relative cover of forbs, grasses, legumes, and woody species. Subsequent ANOVAs were conducted on each response vector to differentiate plant groups that were contributing to differences in cover.. Models included fungicide treatment, year, and fungicide treatment*year interaction were as fixed effects and experimental plot nested within year was a mixed effect. Then we evaluated differences among fungicide treatments and years using Tukeyâ€™s post hoc tests.

RM MANOVA 4 groups as vectors in MANOVA  


```{r manova}
###########################################################################################################
# repeated measures manova

plant_SSE$total_cover <- rowSums(plant_SSE[,112:117]) 
plant_SSE$Grasses <- rowSums(plant_SSE[,112:113]) 

max(plant_SSE$total_cover)
min(plant_SSE$total_cover)
plant_SSE <- plant_SSE %>% mutate(forb_relative = Forbs/total_cover,
                                  C3_relative = C3/total_cover,
                                  C4_relative = C4/total_cover,
                                  woody_relative = Woody/total_cover,
                                  legume_relative = Legumes/total_cover,
                                 # native_relative = Native/total_cover,
                                #  exotic_relative = Exotic/total_cover,
                                  Year= as.factor(Year)#,
                              #  logit_grass = logit(Grasses, min=0, max=1),
                                  )


```

We also assessed whether fungicide treatment influenced patterns in plant community composition. Patterns of plant community dissimilarity were visualized using non-metric multidimensional scaling based on Bray-Curtis distances of plant relative cover. A PERMANOVA (function Adonis) was used to test for differences in communities between years and among fungicide treatments (permutations = 999). To determine whether these results were attributed to both patterns in community abundance (i.e., cover) and composition (i.e., presence-absence), we reran this analysis with a presence-absence plant community matrix and a Jaccard index. 

```{r composition_matrix, echo=FALSE }
set.seed(1234567) #make sure to set seed to get the same result, this is a permutation based method 
# create community matrix and envi data matrix 
plant<-plant_SSE[,8:105] # makes new matrix with community data (columns 2-100)
plot<-plant_SSE[,c(1:5,109:111,121:125)]# makes new matrix with envi data (columns 1-3)
plot$Year <- as.factor(plot$Year)
# more formatting
# remove columns 
plant<-plant[, colSums(abs(plant)) !=0] # removes columns with all zeros

# remove rows without plant just in case (residual from using parasite data where you have uninfected hosts )
plant.2<-plant[rowSums(abs(plant))!=0,]  # remove rows with no plant
plot.2<-plot[rowSums(abs(plant))!=0,]  # remove rows with no plant 

plant_pa<-apply(plant.2,2, function(x) {ifelse(x==0,0,1)})  #makes presence-absence matrix

```

We also assessed whether fungicide treatment influenced patterns in plant community composition. Patterns of plant community dissimilarity were visualized using non-metric multidimensional scaling based on Bray-Curtis distances of plant relative cover. A PERMANOVA (function Adonis) was used to test for differences in communities between years and among fungicide treatments (permutations = 999). To determine whether these results were attributed to both patterns in community abundance (i.e., cover) and composition (i.e., presence-absence), we reran this analysis with a presence-absence plant community matrix and a Jaccard index. 

```{r permanova JAC}
set.seed(1234567) #make sure to set seed to get the same result, this is a permutation based method 
#plant_jac.0<-adonis(formula=plant_pa ~ (Treat) + (Year) , data=plot.2, permutations=999, method="jaccard")
#plant_jac.0
#hist(plant_jac.0$f.perms, main="No strata", xlab="F permuted")

#plant_jac<-adonis(formula=plant_pa ~ (Treat) + (Year) , data=plot.2, strata =plot.2$Plot, permutations=999, method="jaccard")
#plant_jac
#hist(plant_jac$f.perms, main="Strata = plot", xlab="F permuted")

plant_jac2<-adonis(formula=plant_pa ~  Treat *as.factor(Year) , data=plot.2, strata =plot.2$Plot, permutations=999, method="jaccard")
plant_jac2

#
```

Call:
adonis(formula = plant_pa ~ Treat * (Year), data = plot.2, permutations = 999,      method = "jaccard", strata = plot.2$Plot) 

Blocks:  strata 
Permutation: free
Number of permutations: 999

Terms added sequentially (first to last)

            Df SumsOfSqs MeanSqs F.Model      R2 Pr(>F)    
Treat        3     1.204  0.4014  1.7339 0.02350  0.001 ***
Year         2     7.513  3.7564 16.2257 0.14662  0.001 ***
Treat:Year   6     0.852  0.1420  0.6133 0.01663  0.837    
Residuals  180    41.672  0.2315         0.81325           
Total      191    51.241                 1.00000           
---
Signif. codes:  0 â€˜***â€™ 0.001 â€˜**â€™ 0.01 â€˜*â€™ 0.05 â€˜.â€™ 0.1 â€˜ â€™ 1

######################################################################################
```{r permanova BC}
set.seed(1234567) #make sure to set seed to get the same result, this is a permutation based method 
ordO<-metaMDS(plant.2, distance="bray", trymax = 500, autotransform=FALSE) # not transformed 
ordO

#plant_bc.0<-adonis(formula=plant.2 ~ Treat + Year, data=plot.2, permutations=999, method="bray")
#plant_bc.0
#hist(plant_bc.0$f.perms, main="No strata", xlab="F permuted")

#plant_bc<-adonis(formula=plant.2 ~ Treat + Year,  strata = plot.2$Plot, data=plot.2, permutations=999, method="bray")
#plant_bc
#hist(plant_bc$f.perms, main="Strata = plot", xlab="F permuted")

plant_bc.2<-adonis(formula=plant.2 ~ Treat * Year,  strata = plot.2$Plot, data=plot.2, permutations=999, method="bray")
plant_bc.2

```

Call:
metaMDS(comm = plant.2, distance = "bray", trymax = 2000, autotransform = FALSE) 

global Multidimensional Scaling using monoMDS

Data:     plant.2 
Distance: bray 

Dimensions: 2 
Stress:     0.1160433 
Stress type 1, weak ties
Two convergent solutions found after 474 tries
Scaling: centring, PC rotation, halfchange scaling 
Species: expanded scores based on â€˜plant.2â€™ 

####################################################################################
***VECTORS

                  NMDS1    NMDS2     r2 Pr(>r)    
total_biomass   0.97965  0.20070 0.0373  0.032 *  
AUDPS_parasite -0.80091 -0.59878 0.0148  0.258    
Height_cwm      0.91328 -0.40733 0.1473  0.001 ***
###################################################################################

####################################################################################

Call:
adonis(formula = plant.2 ~ Treat * Year, data = plot.2, permutations = 999,      method = "bray", strata = plot.2$Plot) 

Blocks:  strata 
Permutation: free
Number of permutations: 999

Terms added sequentially (first to last)

            Df SumsOfSqs MeanSqs F.Model      R2 Pr(>F)    
Treat        3    0.4574 0.15245  2.3570 0.03222  0.001 ***
Year         2    1.8166 0.90830 14.0428 0.12799  0.001 ***
Treat:Year   6    0.2770 0.04617  0.7139 0.01952  0.206    
Residuals  180   11.6425 0.06468         0.82027           
Total      191   14.1936                 1.00000           
---
Signif. codes:  0 â€˜***â€™ 0.001 â€˜**â€™ 0.01 â€˜*â€™ 0.05 â€˜.â€™ 0.1 â€˜ â€™ 1
########################################################################################

Plant community structure differed among fungicide treatments and across years. However, fungicide treatment explained little variation in patterns of plant cover (PERMANOVA on Bray-Curtis distances, Treat: Pseudo-F = 2.38, p =0.001, R2=0.03) and composition (PERMANOVA on Jaccard distances, Treat: Pseudo-F = 1.76, p =0.003, R2=0.02). As expected, year explained more variation in plant cover (PERMANOVA on Bray-Curtis distances, Year: Pseudo-F = 14.17, p =0.001, R2=0.13) and composition (PERMANOVA on Jaccard distances, Year: Pseudo-F = 16.43 p =0.001, R2=0.15).   

```{r envi vectors}
set.seed(1234567) #make sure to set seed to get the same result, this is a permutation based method 

fit<-envfit(ordO, plot.2[,c(6,8,13)],perm=999)#fits vectors
fit # prints coordinates for host vectors and test of sig

vec.sp.df<-as.data.frame(fit$vectors$arrows)
vec.sp.df <- vec.sp.df[-c(2),] # remove fi index - not significant 
rownames(vec.sp.df)<-c('biomass', "Height CWM")
vec.sp.df<- add_rownames(vec.sp.df, "envi_var")
```
                  NMDS1    NMDS2     r2 Pr(>r)    
total_biomass   0.97965  0.20070 0.0373  0.032 *  
AUDPS_parasite -0.80091 -0.59878 0.0148  0.258    
Height_cwm      0.91328 -0.40733 0.1473  0.001 ***
---
Signif. codes:  0 â€˜***â€™ 0.001 â€˜**â€™ 0.01 â€˜*â€™ 0.05 â€˜.â€™ 0.1 â€˜ â€™ 1
Permutation: free
Number of permutations: 999

```{r NMDS bray curtis}
# scrs17 <-scores(ordO, display = "sites", "species")
# trt_groups <- (c( 'Treat', 'Year')) 
# # 
# #extract info for plotting purposes 
# hcoordO<-as.data.frame(scores(ordO, display="sites")) #extracts coordinates for plot
# pcoordO<-as.data.frame(scores(ordO, display="species")) #extracts coordinates for plant vectors
# pcoordO$plant_sp<- rownames(pcoordO, "Species")
# pcoordO$Species<- rownames(pcoordO, "Species")
# pcoordO <- pcoordO %>% separate(col=plant_sp, into = c("Genus", "spec"))
# pcoordO <- merge(pcoordO, plant_groups, by = c("Species"))
#write.csv(pcoordO, 'plantsp_coordinates_BC_relative_cover.csv')
# 
# plant_all <- bind_cols(plot.2, hcoordO)
# write.csv(plant_all, "NMDS_plant_community_SSE_relative_cover.csv")
# 
# #should have data for 3 yrs and 4 treatments 
# #calculating centroids 
# cent <-aggregate(scrs17 ~ Treat + Year, data = plant_all, FUN = "mean")
# se <- function(z)sd(z)/sqrt(length(z)) # function to calculate std.err
 #ci95 <- function(z) qt(0.025,df=length(z)-1, lower.tail=F)* sd(z)/sqrt(length(z)) 

#cent.95 <- plant_all %>% group_by(Treat, Year) %>% summarise(NMDS1_95= ci95(NMDS1), NMDS2_95 = ci95(NMDS2))
 #cent.95<- aggregate(c(NMDS1, NMDS2) ~ Treat + Year,data=plant_all,ci95)
# cent.SE<- aggregate(scrs17 ~ Treat + Year,data=plant_all,se)
 #cent <- merge(cent, cent.95, by =c("Treat", "Year"))
# write.csv(cent, "NMDS_centroids_plant_community_SSE_relative_cover.csv")
# 
# topp<-max(cent[,5:6]) #determines maximum and minimum values for the plot axes
# bott<-min(cent[,5:6]) #I draw from both data sets because I make the graph sqaure

plant_all$Year <- as.factor(plant_all$Year)
plant_all$Treat <- as.factor(plant_all$Treat)

plant_all_pa$Year <- as.factor(plant_all_pa$Year)
plant_all_pa$Treat <- as.factor(plant_all_pa$Treat)

cent$Year <- as.factor(cent$Year)
cent_pa$Year <- as.factor(cent_pa$Year)
```

```{r nmds graphic, echo=FALSE}
ggplot(plant_all, aes(x= NMDS1, y=NMDS2))+
  geom_hline(yintercept = 0, lty=2, color="grey") +
  geom_vline(xintercept = 0, lty=2, color="grey") +
  geom_point(size =2.75, aes(fill=Treat, shape=Year))+
  xlab("NMDS 1 (B-C)") +
  ylab("NMDS 2 (B-C)") +
  #xlim(c( bott, topp)) +
  #ylim(c( bott, topp)) +
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21))) + 
  scale_shape_manual(values=c(21,25,22)) + 
  scale_linetype_manual(values=c(1,3,5)) + 
  theme_pubr() +
  guides(colour = guide_legend(override.aes = list(size=70)))+
  theme(legend.position = "top", 
        legend.title = element_blank(),
        legend.box = "horizontal") +
  guides(colour = guide_legend(override.aes = list(size=70)))+
  theme(plot.title = element_text(hjust = 0.5, size=15, face="bold"),
        legend.title = element_text(size=8.5, face="bold"),
        legend.text = element_text(size=8))+ 
  theme(legend.position=c(0.13,0.85))+
  facet_wrap(~Treat)+
  guides(fill=guide_legend("Treatment",  keywidth=0.12,
                           keyheight=0.12, override.aes = list(shape=21),
                           default.unit="inch"), color= FALSE)+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1)) # add black square panel around graphic
```

```{r nmds bc centroid}
#jpeg(file="plant_community_centroid_SSE_relative.jpeg", width = 90, height = 250, units = 'mm', res = 300)
cent.graphic <-ggplot(cent, aes(x= NMDS1.x, y=NMDS2.x))+
  geom_hline(yintercept = 0, lty=2, color="grey") +
  geom_vline(xintercept = 0, lty=2, color="grey") +
  geom_errorbar(aes(ymin=NMDS2.x -NMDS2.y,
                    ymax=NMDS2.x+NMDS2.y),width=0.05)+
  geom_errorbarh(aes(xmin=NMDS1.x -NMDS1.y,
                     xmax=NMDS1.x +NMDS1.y),height=0.05)+
  geom_point(size =2.5, aes(fill=Treat, shape=Year))+
  xlab("NMDS 1 (B-C)") +
  ylab("NMDS 2 (B-C)") +
  xlim(c( -0.45, 0.9)) +
 ylim(c( -0.45, 0.4)) +
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
  scale_shape_manual(values=c(21,25,22)) + 
  theme_pubr() +
  theme(legend.position = "top", legend.title = element_blank(), 
        legend.text = element_text(size=4.5), legend.box = "horizontal") +
  theme(legend.title = element_text(size=4.5, face="bold"),
        legend.text = element_text(size=3.5))+ 
  theme(legend.position=c(0.75,0.95))+
  facet_wrap(~Year, ncol=1, nrow = 3)+
  guides(fill=guide_legend("Treatment",  keywidth=0.12,
                           keyheight=0.12, override.aes = list(shape=21),
                           default.unit="inch"), color= FALSE,
         shape=guide_legend("Year",  keywidth=0.12,
                            keyheight=0.12, 
                            default.unit="inch"),
         color=FALSE)+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1)) 
cent.graphic
#dev.off()
```
Now showing a graphic with the species coordiantes 

```{r nmds species coord}
sp_1 <-ggplot(cent, aes(x= NMDS1.x, y=NMDS2.x))+
  geom_hline(yintercept = 0, lty=2, color="grey") +
  geom_vline(xintercept = 0, lty=2, color="grey") +
  #geom_path(aes(color=Treat), lwd=0.5)+
  geom_point(size =2, aes(fill=Treat, shape=Year))+
  geom_text(data= pcoordO, aes(x=NMDS1,y=NMDS2, label=Abbrev), fontface =1, colour = "black" , size=1.5) + # label year
  xlab("NMDS 1 (B-C)") +
  ylab("NMDS 2 (B-C)") +
  # xlim(c( -0.45, 0.9)) +
  #  ylim(c( -0.45, 0.9)) +
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
  scale_shape_manual(values=c(21,25,22)) + 
  # scale_linetype_manual(values=c(1,3,5)) + 
  theme_pubr() +
  theme(legend.position = "top", legend.title = element_blank(), 
        legend.text = element_text(size=4.5), legend.box = "horizontal") +
  theme(legend.title = element_text(size=4.5, face="bold"),
        legend.text = element_text(size=3.5))+ 
  theme(legend.position=c(0.75,0.20))+
  guides(fill=guide_legend("Treatment",  keywidth=0.12,
                           keyheight=0.12, override.aes = list(shape=21),
                           default.unit="inch"), color= FALSE,
         shape=guide_legend("Year",  keywidth=0.12,
                            keyheight=0.12, 
                            default.unit="inch"))+
  geom_segment(data=vec.sp.df,
              aes(x=0,xend=NMDS1,y=0,yend=NMDS2, color=envi_var), # vectors for parasite species
             arrow = arrow(length = unit(0.2, "cm")),
            lty=1,
           )  +
  scale_color_manual(values=c('#7570b3','#d95f02'))+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1)) 

sp_2 <-ggplot(cent, aes(x= NMDS1.x, y=NMDS2.x))+
  geom_hline(yintercept = 0, lty=2, color="grey") +
  geom_vline(xintercept = 0, lty=2, color="grey") +
  geom_point(size =2, aes(fill=Treat  #geom_path(aes(color=Treat), lwd=0.5)+
, shape=Year))+
  geom_text(data= pcoordO, 
            aes(x=NMDS1,y=NMDS2, label=Abbrev), 
            fontface =1,
            colour = "black", 
            size=1.5) + # label year
  xlab("NMDS 1 (B-C)") +
  ylab("NMDS 2 (B-C)") +
  xlim(c( -0.30, 1.0)) +
  ylim(c( -0.42, 0.40)) +
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
  scale_shape_manual(values=c(21,25,22)) + 
  theme_pubr() +
  guides(fill=FALSE, shape=FALSE , color=FALSE
         )+
    geom_segment(data=vec.sp.df,
              aes(x=0,xend=NMDS1,y=0,yend=NMDS2, color=envi_var), # vectors for parasite species
             arrow = arrow(length = unit(0.2, "cm")),
            lty=1,
           )  +
  scale_color_manual(values=c('#7570b3','#d95f02'))+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1)) 

#jpeg(file="plant_community_NMDS_sp_coordinates.jpeg", width = 180, height = 90, units = 'mm', res = 300)
ggarrange(sp_1, sp_2, ncol=2, nrow=1)
#dev.off()
```
fit<-envfit(ordO_p_pa, plot.2[,6],perm=999)#fits disease vectors (AUDPS) to ordination

***VECTORS

        NMDS1    NMDS2     r2 Pr(>r)    
[1,]  0.24461 -0.96962 0.0717  0.001 ***
---
Signif. codes:  0 â€˜***â€™ 0.001 â€˜**â€™ 0.01 â€˜*â€™ 0.05 â€˜.â€™ 0.1 â€˜ â€™ 1
Permutation: free
Number of permutations: 999

```{r NMDS jaccard}
####### now jaccard
# default jaccard doesn't use a PA matrix, still uses abundance, so i convert to PA and then run jaccard 
#ordO_p_pa<-metaMDS(plant_pa, distance="jaccard", trymax =1000, k=3,autotransform=FALSE)
#ordO_p_pa
#fit<-envfit(ordO_p_pa, plot.2[,6],perm=999)#fits disease vectors (AUDPS) to ordination
#fit # prints coordinates for host vectors and test of sig

#scrs_pa <-scores(ordO_p_pa, display = "sites", "species")
#trt_groups <- (c( 'Treat', 'Year')) 

#extract info for plotting purposes 
#hcoordO_pa<-as.data.frame(scores(ordO_p_pa, display="sites")) #extracts coordinates for plot
#pcoordO_pa<-as.data.frame(scores(ordO_p_pa, display="species")) #extracts coordinates for plant vectors
#pcoordO_pa$plant_sp<- rownames(pcoordO_pa, "species")

#add SL mass and FI vectors to parasite vector coords
#NMDS1<-c(fit$vectors$arrows[1,1])
#NMDS2<-c(fit$vectors$arrows[1,2])
#parasite<-data.frame(NMDS1,NMDS2)
#parasite <-parasite %>% mutate(plant_sp = "AUDPS")
#rownames(parasite)<-c("AUDPS")
#pcoordO_pa<-rbind(pcoordO_pa,parasite)

#plant_all_pa <- cbind(plot.2, hcoordO_pa)
#write.csv(plant_all_pa, "NMDS_plant_community_SSE_PA_3D.csv")
#write.csv(pcoordO_pa, "NMDS_plant_species_coordinates_SSE_PA.csv")

#should have data for 3 yrs and 4 treatments 
#calculating centroids 
#cent_pa <-aggregate(scrs_pa ~ Treat + Year, data = plant_all_pa, FUN = "mean")
#se <- function(z)sd(z)/sqrt(length(z)) # function to calculate std.err
#cent.SE.pa<- aggregate(scrs_pa ~ Treat + Year,data=plant_all_pa,se)
#cent_pa <- merge(cent_pa, cent.SE.pa, by =c("Treat", "Year"))
#write.csv(cent_pa, "NMDS_centroids_plant_community_SSE_PA_3D.csv")
#topp2<-max(cent_pa[,4:5]) #determines maximum and minimum values for the plot axes
#bott2<-min(cent_pa[,4:5]) #I draw from both data sets because I make the graph sqaure

```
Call:
metaMDS(comm = plant_pa, distance = "jaccard", trymax = 200,      autotransform = FALSE) 

global Multidimensional Scaling using monoMDS

Data:     plant_pa 
Distance: jaccard 

Dimensions: 2 
Stress:     0.2559644 
Stress type 1, weak ties
Two convergent solutions found after 117 tries
Scaling: centring, PC rotation, halfchange scaling 
Species: expanded scores based on â€˜plant_paâ€™ 
########################################################################################################
added 3 axes because of stress : output for ordination used in MS
########################################################################################################
Call:
metaMDS(comm = plant_pa, distance = "jaccard", k = 3, trymax = 200, autotransform = FALSE) 

global Multidimensional Scaling using monoMDS

Data:     plant_pa 
Distance: jaccard 

Dimensions: 3 
Stress:     0.1789612 
Stress type 1, weak ties
Two convergent solutions found after 32 tries
Scaling: centring, PC rotation, halfchange scaling 
Species: expanded scores based on â€˜plant_paâ€™ 

```{r nmds graphic jac, echo=FALSE}

plant_all_pa %>% mutate(Year = as.factor(Year))%>%
  ggplot(aes(x= NMDS1, y=NMDS2))+
  geom_hline(yintercept = 0, lty=2, color="grey") +
  geom_vline(xintercept = 0, lty=2, color="grey") +
#  geom_path(aes(color=Treat), lwd=0.5)+
  geom_point(size =2.75, aes(x= NMDS1, y=NMDS2, fill=Treat, shape=Year))+
  xlab("NMDS 1 (JAC)") +
  ylab("NMDS 2 (JAC)") +
  #xlim(c( bott, topp)) +
  #ylim(c( bott, topp)) +
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
  scale_color_manual(values=c('#fed976','#a1dab4','#41b6c4','#225ea8'))+
  scale_shape_manual(values=c(21,25,22)) + 
  scale_linetype_manual(values=c(1,3,5)) + 
  rita_theme+
  guides(colour = guide_legend(override.aes = list(size=70)))+
  theme(legend.position = "top", legend.title = element_blank(), 
        legend.text = element_text(size=15), legend.box = "horizontal") +
  guides(colour = guide_legend(override.aes = list(size=70)))+
  theme(legend.position=c(0.13,0.85))+
  facet_wrap(~Treat)+
  guides(fill=guide_legend("Treatment",  keywidth=0.12,
                           keyheight=0.12, override.aes = list(shape=21),
                           default.unit="inch"), color= FALSE)+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1)) # add black square panel around graphic

plant_all_pa %>% mutate(Year = as.factor(Year))%>%
ggplot( aes(x= NMDS1, y=NMDS3))+
  geom_hline(yintercept = 0, lty=2, color="grey") +
  geom_vline(xintercept = 0, lty=2, color="grey") +
 # geom_path(aes(color=Plot), lwd=0.5)+
  geom_point(size =2.75, aes(x= NMDS1, y=NMDS2, fill=Treat, shape=Year))+
  xlab("NMDS 1 (JAC)") +
  ylab("NMDS 2 (JAC)") +
  #xlim(c( bott, topp)) +
  #ylim(c( bott, topp)) +
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
 # scale_color_manual(values=c('#fed976','#a1dab4','#41b6c4','#225ea8'))+
  scale_shape_manual(values=c(21,25,22)) + 
  scale_linetype_manual(values=c(1,3,5)) + 
    rita_theme+
  guides(colour = guide_legend(override.aes = list(size=70)))+
  theme(legend.position = "top", legend.title = element_blank(), 
        legend.text = element_text(size=15), legend.box = "horizontal") +
  guides(colour = guide_legend(override.aes = list(size=70)))+
  theme(legend.position=c(0.13,0.85))+
  facet_wrap(~Treat)+
  guides(fill=guide_legend("Treatment",  keywidth=0.12,
                           keyheight=0.12, override.aes = list(shape=21),
                           default.unit="inch"), color= FALSE)+
  guides(fill=FALSE, shape=FALSE)+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1)) # 


plant_all_pa %>% mutate(Year = as.factor(Year))%>%
ggplot( aes(x= NMDS2, y=NMDS3))+
  geom_hline(yintercept = 0, lty=2, color="grey") +
  geom_vline(xintercept = 0, lty=2, color="grey") +
 # geom_path(aes(color=Plot), lwd=0.5)+
  geom_point(size =2.75, aes(x= NMDS1, y=NMDS2, fill=Treat, shape=Year))+
  xlab("NMDS 1 (JAC)") +
  ylab("NMDS 2 (JAC)") +
  #xlim(c( bott, topp)) +
  #ylim(c( bott, topp)) +
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
 # scale_color_manual(values=c('#fed976','#a1dab4','#41b6c4','#225ea8'))+
  scale_shape_manual(values=c(21,25,22)) + 
  scale_linetype_manual(values=c(1,3,5)) + 
  rita_theme+
  guides(colour = guide_legend(override.aes = list(size=70)))+
  theme(legend.position = "top", legend.title = element_blank(), 
        legend.text = element_text(size=15), legend.box = "horizontal") +
  guides(colour = guide_legend(override.aes = list(size=70)))+
  theme(legend.position=c(0.13,0.85))+
  facet_wrap(~Treat)+
  guides(fill=guide_legend("Treatment",  keywidth=0.12,
                           keyheight=0.12, override.aes = list(shape=21),
                           default.unit="inch"), color= FALSE)+
  guides(fill=FALSE, shape=FALSE)+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1)) # 
```

```{r jac_nmds_centroid}
cent_pa <- cent_pa %>% mutate(Year = as.factor(Year))

#jpeg(file="plant_community_centroid_SSE.jpeg", width = 90, height = 90, units = 'mm', res = 300)
nmds12 <-cent_pa %>% 
  ggplot(aes(x= NMDS1.x, y=NMDS2.x))+
  geom_hline(yintercept = 0, lty=2, color="grey") +
  geom_vline(xintercept = 0, lty=2, color="grey") +
 # geom_path(aes(color=Treat), lwd=0.5)+
  geom_errorbar(aes(ymin=NMDS2.x -NMDS2.y,
                    ymax=NMDS2.x+NMDS2.y),width=0.05)+
  geom_errorbarh(aes(xmin=NMDS1.x -NMDS1.y,
                     xmax=NMDS1.x +NMDS1.y),height=0.05)+
  geom_point(size =2.5, data=cent_pa, aes(fill=Treat, shape=Year))+
  xlab("NMDS 1 (JAC)") +
  ylab("NMDS 2 (JAC)") +
   xlim(c(-0.45, 0.5)) +
  ylim(c(-0.45, 0.5)) +
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
  scale_color_manual(values=c('#fed976','#a1dab4','#41b6c4','#225ea8'))+
  scale_shape_manual(values=c(21,25,22)) + 
  scale_linetype_manual(values=c(1,3,5)) + 
  rita_theme+
  theme(legend.position = "top", legend.title = element_blank(), 
        legend.text = element_text(size=4.5), legend.box = "horizontal") +
  theme(legend.title = element_text(size=4.5, face="bold"),
        legend.text = element_text(size=3.5))+ 
  theme(legend.position=c(0.80,0.85))+
  guides(fill=guide_legend("Treatment",  keywidth=0.12,
                           keyheight=0.12, override.aes = list(shape=21),
                           default.unit="inch"), color= FALSE,
         shape=guide_legend("Year",  keywidth=0.12,
                            keyheight=0.12, 
                            default.unit="inch"))+
  facet_wrap(~Year, ncol=1, nrow=3)+
  # geom_segment(data=parasite,aes(x=0,xend=NMDS1,y=0,yend=NMDS2), # vectors for parasite species 
  #             arrow = arrow(length = unit(0.25, "cm")),colour=c("black")) + 
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1)) # add black square panel around graphic
#dev.off()

nmds13<-cent_pa %>% 
  ggplot(aes(x= NMDS1.x, y=NMDS3.x))+
  geom_hline(yintercept = 0, lty=2, color="grey") +
  geom_vline(xintercept = 0, lty=2, color="grey") +
  #geom_path(aes(color=Treat), lwd=0.5)+
  geom_errorbar(aes(ymin=NMDS3.x -NMDS3.y,
                    ymax=NMDS3.x+NMDS3.y),width=0.05)+
  geom_errorbarh(aes(xmin=NMDS1.x -NMDS1.y,
                     xmax=NMDS1.x +NMDS1.y),height=0.05)+
  geom_point(size =2.5, data=cent_pa, aes(fill=Treat, shape=Year))+
  xlab("NMDS 1 (JAC)") +
  ylab("NMDS 3 (JAC)") +
   xlim(c(-0.45, 0.5)) +
  ylim(c(-0.45, 0.5)) +
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
  scale_color_manual(values=c('#fed976','#a1dab4','#41b6c4','#225ea8'))+
  scale_shape_manual(values=c(21,25,22)) + 
  scale_linetype_manual(values=c(1,3,5)) + 
  rita_theme+
  theme(legend.position = "top", legend.title = element_blank(), 
        legend.text = element_text(size=4.5), legend.box = "horizontal") +
  theme(legend.title = element_text(size=4.5, face="bold"),
        legend.text = element_text(size=3.5))+ 
  theme(legend.position=c(0.80,0.85))+
  guides(fill=guide_legend("Treatment",  keywidth=0.12,
                           keyheight=0.12, override.aes = list(shape=21),
                           default.unit="inch"), color= FALSE,
         shape=guide_legend("Year",  keywidth=0.12,
                            keyheight=0.12, 
                            default.unit="inch"))+
  facet_wrap(~Year, ncol=1, nrow=3)+
  # geom_segment(data=parasite,aes(x=0,xend=NMDS1,y=0,yend=NMDS2), # vectors for parasite species 
  #             arrow = arrow(length = unit(0.25, "cm")),colour=c("black")) + 
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1)) 

nmds23<-cent_pa %>% 
  ggplot( aes(x= NMDS2.x, y=NMDS3.x))+
  geom_hline(yintercept = 0, lty=2, color="grey") +
  geom_vline(xintercept = 0, lty=2, color="grey") +
 # geom_path(aes(color=Treat), lwd=0.5)+
  geom_errorbar(aes(ymin=NMDS3.x -NMDS3.y,
                    ymax=NMDS3.x+NMDS3.y),
                width=0.05)+
  geom_errorbarh(aes(xmin=NMDS2.x -NMDS2.y,
                     xmax=NMDS2.x +NMDS2.y),
                 height=0.05)+
  geom_point(size =2.5, data=cent_pa, aes(fill=Treat, shape=Year))+
  xlab("NMDS 2 (JAC)") +
  ylab("NMDS 3 (JAC)") +
  xlim(c(-0.45, 0.5)) +
  ylim(c(-0.45, 0.5)) +
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
  scale_color_manual(values=c('#fed976','#a1dab4','#41b6c4','#225ea8'))+
  scale_shape_manual(values=c(21,25,22)) + 
  scale_linetype_manual(values=c(1,3,5)) + 
  rita_theme +
  theme(legend.position = "top", legend.title = element_blank(), 
        legend.text = element_text(size=4.5), legend.box = "horizontal") +
  theme(legend.title = element_text(size=4.5, face="bold"),
        legend.text = element_text(size=3.5))+ 
  theme(legend.position=c(0.80,0.85))+
  guides(fill=guide_legend("Treatment",  keywidth=0.12,
                           keyheight=0.12, override.aes = list(shape=21),
                           default.unit="inch"), color= FALSE,
         shape=guide_legend("Year",  keywidth=0.12,
                            keyheight=0.12, 
                            default.unit="inch"))+
  facet_wrap(~Year, ncol=1, nrow=3)+
  # geom_segment(data=parasite,aes(x=0,xend=NMDS1,y=0,yend=NMDS2), # vectors for species 
  #             arrow = arrow(length = unit(0.25, "cm")),colour=c("black")) + 
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1))

#jpeg(file="plant_community_centroid_JAC_SSE.jpeg", width = 270, height = 220, units = 'mm', res = 300)
ggarrange(nmds12, nmds13, nmds23, ncol=3, common.legend = TRUE)
#dev.off()
```

Here we are calculating distance from the centroid as a measure of beta diversity 

```{r distance centroid}
cent <- cent %>% dplyr::select(-c(X1))
plant_all <- plant_all %>% dplyr::select(-c(X1))
nmds_all <- merge(cent, plant_all, by = c("Treat", "Year"))
```

```{r dist cent function}
dist.pt <- function(x1, y1, x2, y2) sqrt((x2-x1)^2 + (y2-y1)^2) # finds distance between points 

plot_list <- unique(nmds_all$Plot)
time_list <- unique(nmds_all$Year)

out_centroid <- data.frame()

for (i in plot_list){
  for (j in time_list) {
  plot_id <- i
  year <- j 
  plot_target <- nmds_all %>% 
    filter(Plot == i) %>%
    filter(Year == j)
  
  # plot_target <- nmds_all %>% 
   # filter(Plot == 1) %>%
  #  filter(Year == 2017)
  
  from_center<- dist.pt (as.numeric(plot_target[1,3]),
                         as.numeric(plot_target[1,4]),
                         as.numeric(plot_target[1,16]), 
                         as.numeric(plot_target[1,17] ))
  
  d_cent <- data.frame(i, j, from_center)
  out_centroid <-rbind(out_centroid, d_cent)
  }
}

col_head <- c('Plot', 'Year',  'distance_centroid' )
colnames(out_centroid) <- col_head

drift_cent <- merge(nmds_all, out_centroid, by =c("Plot", "Year"))
```

```{r RM anova distance centroid}
#cent.mod <- aov(distance_centroid ~ Treat * as.factor(Year), data= drift_cent)
#summary(cent.mod)

drift_cent <- drift_cent %>% 
  mutate(Plot = as.factor(Plot), Year = as.factor(Year),
         log_dist = log10(distance_centroid))
cent.modrm2 <- aov(log_dist ~ Treat * Year + Error(Plot/Year), data= drift_cent)
cent.mod1 <-aov_car(log_dist ~ Treat * Year + Error(Plot/Year), data= drift_cent)
cent.mod1
#check.model(cent.mod1, drift_cent)

dis.cent.out <- emmeans(cent.modrm2, ~ Treat * Year) %>% data.frame()
dis.post <- emmeans(cent.mod1, ~ Treat * Year)
multcomp::cld(dis.post, alpha = 0.05, Letters = LETTERS)
#pairs(postcent)

```
Produces graphic and RM ANOVA 

```{r dist_cent_graphic}
dodge <- position_dodge(width = 0.7)

#jpeg(file="distance_centroid_plant_SSE.jpeg", width = 180, height = 150, units = 'mm', res = 300)
drift_cent %>%  mutate(Year = as.factor(Year))%>%
  ggplot(aes(x=Year, y = log10(distance_centroid)))+
  #  geom_violin(aes(x=Year, y = log10(distance_centroid), fill=Treat),position = dodge)+ 
  #  geom_point(aes(x=Year, y = log10(distance_centroid),  fill=Treat), pch=21, position = dodge)+
  # geom_errorbar(err_sd_shan, position=dodge, width=0.1) +
  # geom_point(aes(x=Year, y =log10(fn1), fill=Treat), data=drift_mean, pch=21, size=2.75, position=dodge)+
  # arrange(Year) %>% 
  geom_boxplot(aes(x=Year, y = log10(distance_centroid), colour=Treat), 
               width=0.5, position = dodge, outlier.colour = NULL)+ 
  geom_boxplot(aes(x=Year, y = log10(distance_centroid), fill=Treat),
               width=0.5, position = dodge, outlier.size=-1)+ 
  rita_theme + 
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
  theme(legend.position = c(0.15, 0.85))+
  scale_colour_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
  labs(x="", y="log distance from centroid")+
  guides(colour=FALSE)+
  # 
  annotate("text", x = 0.73, y = -0.80, label = "a", size=2) + #17 never sprayed
  annotate("text", x = 0.90, y = -0.80, label = "a", size=2) +  #17 always sprayed
  annotate("text", x = 1.10, y = -0.70, label = "ab", size=2) +  #17 cr->p
  annotate("text", x = 1.25, y = -0.55, label = "b", size=2) +  #17 crp
  #
  annotate("text", x = 1.73, y = 0, label = "c", size=2) + #18 never sprayed
  annotate("text", x = 1.90, y = 0, label = "cd", size=2) +  #18 always sprayed
  annotate("text", x = 2.10, y = 0, label = "c", size=2) +  #18 cr->p
  annotate("text", x = 2.25, y = 0.28, label = "de", size=2) +  #18 crp
  # 
  annotate("text", x = 2.73, y = 0.18, label = "c", size=2) + #19 never sprayed
  annotate("text", x = 2.90, y = 0.25, label = "cde", size=2) +  #19 always sprayed
  annotate("text", x = 3.10, y = 0.18, label = "c", size=2) +  #19 cr->p
  annotate("text", x = 3.25, y = 0.28, label = "e", size=2)  #19 crp
#dev.off()
```

```{r dist cent graphic2}
drift_cent <- drift_cent %>% mutate(Year = as.factor(Year))
err <- aes(ymin=lower.CL, ymax=upper.CL)

#jpeg(file="distance_centroid_plant_SSE.jpeg", width = 180, height = 150, units = 'mm', res = 300)
distance.graph <-dis.cent.out %>%
  ggplot(aes(x= Year, y = emmean, fill = Treat))+
  geom_point(aes(x=Year, y = log10(distance_centroid), group=Treat, fill=Treat), 
             pch=21,data=drift_cent,           
             position=position_jitterdodge(dodge.width=0.70,  jitter.width = 0.20), 
             size=0.8, alpha=0.35)+
  geom_errorbar(aes(ymax = upper.CL, ymin = lower.CL), 
                  position =dodge, width = 0.1, show.legend = FALSE,  color = "black") +
  geom_point(aes(x= Year, y = emmean, fill = Treat), position=dodge, pch=21, size = 2.5)+ 
  rita_theme + 
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
  theme(legend.position = c(0.15, 0.85))+
  labs(x = "",  y = bquote('log'[10]~'distance from the centroid'))+
  guides(fill=guide_legend("Treatment",  keywidth=0.12,
                           keyheight=0.12, override.aes = list(shape=21),
                           default.unit="inch"), color= FALSE)+
   theme(legend.title = element_text(size=7, face="bold"),
        legend.text = element_text(size=6.5))+ 
  # 
  annotate("text", x = 0.73, y = -1.0, label = "a", size=2) + #17 never sprayed
  annotate("text", x = 0.90, y = -1.0, label = "a", size=2) +  #17 always sprayed
  annotate("text", x = 1.10, y = -0.90, label = "ab", size=2) +  #17 cr->p
  annotate("text", x = 1.25, y = -0.60, label = "b", size=2) +  #17 crp
  #
  annotate("text", x = 1.73, y = -0.20, label = "c", size=2) + #18 never sprayed
  annotate("text", x = 1.90, y = -0.10, label = "cd", size=2) +  #18 always sprayed
  annotate("text", x = 2.10, y = -0.20, label = "c", size=2) +  #18 cr->p
  annotate("text", x = 2.25, y = 0.20, label = "de", size=2) +  #18 crp
  # 
  annotate("text", x = 2.73, y = -0.20, label = "c", size=2) + #19 never sprayed
  annotate("text", x = 2.90, y = 0.05, label = "cde", size=2) +  #19 always sprayed
  annotate("text", x = 3.10, y = -0.20, label = "c", size=2) +  #19 cr->p
  annotate("text", x = 3.25, y = 0.28, label = "e", size=2)  #19 crp
distance.graph
#dev.off()
```
```{r nmds analysis multi panel graph}
#jpeg(file="plant_community_centroid_SSE_wspvectors.jpeg", width = 180, height = 250, units = 'mm', res = 300)
#ggarrange(cent.graphic, sp_2, ncol = 2, nrow=, widths =c(1,1))
  grid.arrange(sp_2, cent.graphic,  distance.graph,                             # box plot and scatter plot
               ncol = 2, nrow = 2, 
               layout_matrix = rbind(c(2,1), c(2,3)),
               #labels = c("A", "B", "c"),
widths = c(1, 1.2), heights = c(0.75, 0.75))
#dev.off()
```

 Treat   Year emmean     SE  df lower.CL upper.CL .group
 Control 2017 -1.713 0.0817 128   -1.875  -1.5517  A    
 C->R->P 2017 -1.678 0.0817 128   -1.839  -1.5160  A    
 CR->P   2017 -1.485 0.0817 128   -1.647  -1.3236  AB   
 CRP     2017 -1.208 0.0817 128   -1.370  -1.0465   B   
 C->R->P 2018 -0.814 0.0817 128   -0.975  -0.6523    C  
 CR->P   2019 -0.798 0.0817 128   -0.960  -0.6365    C  
 CR->P   2018 -0.788 0.0817 128   -0.949  -0.6261    C  
 C->R->P 2019 -0.742 0.0817 128   -0.904  -0.5805    C  
 Control 2018 -0.649 0.0817 128   -0.811  -0.4876    CD 
 Control 2019 -0.480 0.0817 128   -0.642  -0.3185    CDE
 CRP     2018 -0.326 0.0817 128   -0.488  -0.1646     DE
 CRP     2019 -0.257 0.0817 128   -0.419  -0.0953      E

Warning: EMMs are biased unless design is perfectly balanced 
Confidence level used: 0.95 
P value adjustment: tukey method for comparing a family of 12 estimates 
significance level used: alpha = 0.05 

```{r nmds temporal variation}
#cent <- cent %>% dplyr::select(-c(X1))
#plant_all <- plant_all %>% dplyr::select(-c(X1))

dist.pt <- function(x1, y1, x2, y2) sqrt((x2-x1)^2 + (y2-y1)^2) # finds distance between points 

plot_list <- unique(plant_all$Plot)

temporal_distance <- data.frame()

for (i in plot_list){
  plot_id <- i
  plot_target <- plant_all %>% 
    filter(Plot == i) %>% 
    arrange(Year)
  
   #plot_target <- plant_all %>% 
  #  filter(Plot == 1) %>%
   #  arrange(Year)
  
  plot_moved<- data.frame(distance2017_2018 = dist.pt(as.numeric(plot_target[1,12]), as.numeric(plot_target[1,13]),
                                                       as.numeric(plot_target[2,12]), as.numeric(plot_target[2,13] )),
                           distance2018_2019 = dist.pt(as.numeric(plot_target[2,12]), as.numeric(plot_target[2,13]),
                                                       as.numeric(plot_target[3,12]), as.numeric(plot_target[3,13] )),
                          distance2017_2019 = dist.pt(as.numeric(plot_target[1,12]), as.numeric(plot_target[1,13]),
                                                       as.numeric(plot_target[3,12]), as.numeric(plot_target[3,13] ))
                          )
  
  d_cent <- data.frame(i, plot_moved)
  temporal_distance <-rbind(temporal_distance, d_cent)
}

col_head <- c('Plot', 'TIME2017_2018',  'TIME2018_2019' , '2017 - 2019')
colnames(temporal_distance) <- col_head

temporal_dissimilarity <- merge(plot_treatment, temporal_distance, by =c("Plot"))

```

```{r temporal change graphic}

temp_tidy <- temporal_dissimilarity %>% 
  gather(Time, distance, 7:8) %>%
  group_by(Plot, Treat, Time) %>%
  summarise_at(c("distance"), mean)

dodge <- position_dodge(width = 0.7)

# temp_tidy %>% ggplot(aes(x= Time, y = distance, fill=Treat))+
#  # geom_point(aes(x=Time, y = log10(distance),  fill=Treat), pch=21, position = dodge)+ 
#   geom_boxplot(aes(x=Time, y = log10(distance), colour=Treat), width=0.5, position = dodge, outlier.colour = NULL)+ 
#   geom_boxplot(aes(x=Time, y = log10(distance), fill=Treat), width=0.5, position = dodge, outlier.size=-1)+ 
#   theme_bw() +
#   scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
#                     guide=guide_legend(override.aes=list(shape=21)), 
#                     labels = c("Never", "Always", "CR->P", "CRP")) +
#     scale_colour_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
#                     guide=guide_legend(override.aes=list(shape=21)), 
#                     labels = c("Never", "Always", "CR->P", "CRP")) +
#   guides(colour=FALSE)+
#   labs(x="", y="Temporal dissimilarity")

temp_tidy %>% ggplot(aes(x= Treat, y = distance, fill=Treat))+
 # geom_point(aes(x=Time, y = log10(distance),  fill=Treat), pch=21, position = dodge)+ 
 # geom_boxplot(aes(x=Time, y = log10(distance), colour=Treat), width=0.5, position = dodge, outlier.colour = NULL)+ 
  geom_boxplot(aes(x=Time, y = log10(distance), fill=Treat), width=0.5, position = dodge, outlier.size=-1)+ 
  theme_bw() +
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
    scale_colour_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("Never", "Always", "CR->P", "CRP")) +
  guides(colour=FALSE, fill=FALSE)+
 # facet_wrap(~Time)+
  labs(x="", y="Temporal community dissimilarity")

```

```{r temporal dissimilarity anova}
final_temp <- temporal_dissimilarity %>% 
  gather(Time, distance, 9) %>%
  group_by(Plot, Treat, Time) %>%
  summarise_at(c("distance"), mean)

tempdist.mod <- aov(log10(distance) ~ Treat, data= final_temp)
summary(tempdist.mod)

final_temp2 <- temporal_dissimilarity %>% 
  gather(Time, distance, 7:8) %>%
  group_by(Plot, Treat, Time) %>%
  summarise_at(c("distance"), mean)

tempdist.mod2 <- aov(log10(distance) ~ Treat + Time + Error(Plot/Time), data= final_temp2)
aov_car(log10(distance) ~ Treat * Time + Error(Plot/Time), data= final_temp2)

#summary(tempdist.mod2)
```


```{r temp comm and parasite}
change_disease <- plant_SSE %>% 
  group_by(Plot)%>%
  mutate(Anthracnose_17 =Anthracnose - Anthracnose[Year == '2017'],
         Anthracnose_18 =Anthracnose - Anthracnose[Year == '2018'],
         Rhiz_17 =Rhiz- Rhiz[Year == '2017'],
         Rhiz_18 =Rhiz - Rhiz[Year == '2018'],
         Rust_17 =Rust- Rust[Year == '2017'],
         Rust_18 =Rust - Rust[Year == '2018'],
         fescue_17 = Schedonorus_arundinaceus- Schedonorus_arundinaceus[Year == '2017'],
        fescue_18 = Schedonorus_arundinaceus- Schedonorus_arundinaceus[Year == '2018'],
        rich_17 = sp_rich - sp_rich[Year == '2017'],
        rich_18 = sp_rich - sp_rich[Year == '2018'],
        parasite_17 = AUDPS_parasite - AUDPS_parasite[Year =='2017'],
        parasite_18 = AUDPS_parasite - AUDPS_parasite[Year =='2018'])%>%
  dplyr::select(Plot, Year, Treat, 
                Anthracnose_17, Anthracnose_18, 
                Rhiz_17, Rhiz_18, 
                Rust_17, Rust_18, 
                fescue_17, fescue_18,
                rich_17, rich_18,
                parasite_17, parasite_18)

change_disease_1718 <- change_disease  %>% 
  filter(Year == '2018') %>% 
  filter(Anthracnose_17 != 0) %>%
  mutate(Time = 'TIME2017_2018')%>%
  select(Plot, Time, Anthracnose_17, Rhiz_17,  Rust_17, 
         fescue_17, rich_17, parasite_17)%>%
  rename(Anthracnose ='Anthracnose_17', Rhiz = 'Rhiz_17', Rust = 'Rust_17', 
         fescue = 'fescue_17', sp_rich = 'rich_17', pathogen = 'parasite_17')

change_disease_1819 <- change_disease  %>% 
  filter(Year == '2019') %>% 
  filter(Anthracnose_18 != 0) %>%
  mutate(Time = 'TIME2018_2019')%>%
  select(Plot, Time, Anthracnose_18, Rhiz_18,  Rust_18, 
         fescue_18, rich_18, parasite_18)%>%
  rename(Anthracnose ='Anthracnose_18', Rhiz = 'Rhiz_18', Rust = 'Rust_18',
         fescue = 'fescue_18', sp_rich = 'rich_18',  pathogen = 'parasite_18')

epidemic_change <- rbind(change_disease_1718, change_disease_1819)

disease_community_change <- merge(epidemic_change, temp_tidy, by =c("Plot", 'Time'))

disease_c_tidy <- disease_community_change %>% 
  gather(parasite, epidemic, 3:5)
```

```{r graphics for parasite change}
# disease_community_change %>%
#   ggplot()+
#   geom_hline(yintercept = 0, lty=2, lwd=1.25, col='red')+
#   geom_vline(xintercept = 0, lty=2, lwd=1.25, col='black')+
#   geom_point(aes(x=Anthracnose, y = Rhiz), pch=21, size=3)+
#   geom_smooth(aes(x=Anthracnose, y = Rhiz), size =1.5,  se = FALSE, method='lm') +
#   facet_wrap(~Time*Treat,ncol=4, nrow=2 #, scales='free'
#   )+
#   labs(x='change in anthracnose epidemic',
#        y ='change in rhizoctonia epidemic')+
#   theme_bw()
# 
# disease_community_change %>%
#   ggplot()+
#   geom_hline(yintercept = 0, lty=2, lwd=1.25, col='red')+
#   geom_vline(xintercept = 0, lty=2, lwd=1.25, col='black')+
#   geom_point(aes(x=Rhiz, y = Rust), pch=21, size=3)+
#   geom_smooth(aes(x=Rhiz, y = Rust), size =1.5,  se = FALSE, method='lm') +
#   facet_wrap(~Time*Treat,ncol=4, nrow=2 #, scales='free'
#   )+
#   labs(x='change in rhizoctonia epidemic',
#        y ='change in rust epidemic')+
#   theme_bw()
# 
# disease_community_change %>%
#   ggplot()+
#   geom_hline(yintercept = 0, lty=2, lwd=1.25, col='red')+
#   geom_vline(xintercept = 0, lty=2, lwd=1.25, col='black')+
#   geom_point(aes(x=Anthracnose, y = Rust), pch=21, size=3)+
#   geom_smooth(aes(x=Anthracnose, y = Rust), size =1.5,  se = FALSE, method='lm') +
#   facet_wrap(~Time*Treat,ncol=4, nrow=2 #, scales='free'
#   )+
#   labs(x='change in anthracnose epidemic',
#        y ='change in rust epidemic')+
#   theme_bw()

```

```{r graphics for disease change}
# disease_c_tidy%>%
#   ggplot()+
#   geom_hline(yintercept = 0, lty=2, lwd=1)+
#   geom_point(aes(x=log10(distance), y = epidemic, fill=parasite), pch=21, size=3)+ 
#   geom_smooth(aes(x=log10(distance), y = (epidemic), group=parasite, color=parasite), size =1.5,  se = FALSE, method='lm') +
#   facet_wrap(~Time*Treat,ncol=4, nrow=2 #, scales='free'
#              )+
#   labs(x='change in host community composition (euclidean distance moved by a community)', 
#        y ='change in parasite epidemic (diff. in annual AUDPS)')+
#   theme_bw()
# 
# disease_c_tidy%>%
#   ggplot()+
#   geom_hline(yintercept = 0, lty=2, lwd=1)+
#   geom_point(aes(x=log10(distance), y = epidemic, fill=Treat, shape=Time), size=3)+ 
#   geom_smooth(aes(x=log10(distance), y = (epidemic), group=Treat, color=Treat), size =1.5,  se = FALSE, method='lm') +
#   facet_wrap(~parasite*Time,ncol=3, nrow=2 , scales='free'
#              )+
#   scale_color_manual(values=c('#fed976','#a1dab4','#41b6c4','#225ea8'))+
#   scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
#                     guide=guide_legend(override.aes=list(shape=21))) + 
#   scale_shape_manual(values=c(21,25)) + 
#   labs(x='change in host community composition (euclidean distance moved by a community)', 
#        y ='change in parasite epidemic (diff. in annual AUDPS)')+
#   theme_bw()
# 
# disease_c_tidy%>%
#   filter(Treat == 'C->R->P')%>%
#   ggplot()+
#   geom_hline(yintercept = 0, lty=2, lwd=1)+
#   geom_point(aes(x=log10(distance), y = epidemic, fill=Time, shape=Time), size=3)+ 
#   geom_smooth(aes(x=log10(distance), y = (epidemic), group=Time, color=Time), size =1.5,  se = FALSE, method='lm') +
#   facet_wrap(~parasite,ncol=3, nrow=1 , scales='free'
#   )+
#   scale_color_manual(values=c('blue', 'grey'))+
#   scale_fill_manual(values=c('blue', 'grey'),
#                     guide=guide_legend(override.aes=list(shape=21))) + 
#   scale_shape_manual(values=c(21,25)) + 
#   labs(x='change in host community composition (euclidean distance moved by a community)', 
#        y ='change in parasite epidemic (diff. in annual AUDPS)')+
#   theme_bw()
# 
# # disease_c_tidy%>%
# #   ggplot()+
# #   geom_hline(yintercept = 0, lty=2, lwd=1)+
# #   geom_point(aes(x=log10(distance), y = pathogen), pch=21, size=3)+ 
# #   geom_smooth(aes(x=log10(distance), y = pathogen), size =1.5,  se = FALSE, method='lm') +
# #   facet_wrap(~Time*Treat,ncol=4, nrow=2 #, scales='free'
# #              )+
# #   labs(x='compositional host community change (euclidean distance moved by a community)', 
# #        y ='change in parasite epidemic (diff. in annual AUDPS)')+
# #   theme_bw()
# 
# disease_c_tidy%>%
#   ggplot()+
#   geom_hline(yintercept = 0, lty=2, lwd=1.25, col='red')+
#   geom_vline(xintercept = 0, lty=2, lwd=1.25, col='blue')+
#   geom_point(aes(x=fescue, y = epidemic, fill=parasite), pch=21, size=3)+ 
#   geom_smooth(aes(x=fescue, y = (epidemic), group=parasite, color=parasite), size =1.5,  se = FALSE, method='lm') +
#   facet_wrap(~Time*Treat,ncol=4, nrow=2 #, scales='free'
#   )+
#   labs(x='change in fescue cover', 
#        y ='change in parasite epidemic (diff. in annual AUDPS)')+
#   theme_bw()
# 
# disease_c_tidy%>%
#   ggplot()+
#   geom_hline(yintercept = 0, lty=2, lwd=1)+
#   geom_vline(xintercept = 0, lty=2, lwd=1)+
#   geom_point(aes(x=fescue, y = epidemic, fill=Treat, shape=Time), size=3)+ 
#   geom_smooth(aes(x=fescue, y = (epidemic), group=Treat, color=Treat), size =1.5,  se = FALSE, method='lm') +
#   facet_wrap(~parasite*Time,ncol=2, nrow=3 , scales='free'
#   )+
#   scale_color_manual(values=c('#fed976','#a1dab4','#41b6c4','#225ea8'))+
#   scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
#                     guide=guide_legend(override.aes=list(shape=21))) + 
#   scale_shape_manual(values=c(21,25)) + 
#   labs(x='change in fescue cover', 
#        y ='change in parasite epidemic (diff. in annual AUDPS)')+
#   theme_bw()

# 
# disease_c_tidy%>%
#   ggplot()+
#   geom_hline(yintercept = 0, lty=2, lwd=1.25, col='red')+
#   geom_vline(xintercept = 0, lty=2, lwd=1.25, col='blue')+
#   geom_point(aes(x=sp_rich, y = epidemic, fill=parasite), pch=21, size=3)+ 
#   geom_smooth(aes(x=sp_rich, y = (epidemic), group=parasite, color=parasite), size =1.5,  se = FALSE, method='lm') +
#   facet_wrap(~Time*Treat,ncol=4, nrow=2 #, scales='free'
#   )+
#   labs(x='change plant richness', 
#        y ='change in parasite epidemic (diff. in annual AUDPS)')+
#   theme_bw()
# 
# #jpeg(file="richnes_epidemic_change.jpeg", width = 180, height = 270, units = 'mm', res = 300)
# disease_c_tidy%>%
#   ggplot()+
#   geom_hline(yintercept = 0, lty=2, lwd=1)+
#   geom_vline(xintercept = 0, lty=2, lwd=1)+
#   geom_point(aes(x=sp_rich, y = epidemic, fill=Treat, shape=Time), size=3)+ 
#   geom_smooth(aes(x=sp_rich, y = (epidemic), group=Treat, color=Treat), size =1.5,  se = FALSE, method='lm') +
#   facet_wrap(~parasite*Time,ncol=2, nrow=3 , scales='free'
#   )+
#   scale_color_manual(values=c('#fed976','#a1dab4','#41b6c4','#225ea8'))+
#   scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
#                     guide=guide_legend(override.aes=list(shape=21))) + 
#   scale_shape_manual(values=c(21,25)) + 
#   labs(x='change in plant richness', 
#        y ='change in parasite epidemic (diff. in annual AUDPS)')+
#   theme_bw()
# #dev.off()

# disease_c_tidy%>%
#   ggplot()+
#   geom_hline(yintercept = 0, lty=2, lwd=1)+
#   geom_point(aes(x=sp_rich, y = pathogen), pch=21, size=3)+ 
#   geom_smooth(aes(x=sp_rich, y = pathogen), size =1.5,  se = FALSE, method='lm') +
#   facet_wrap(~Time*Treat,ncol=4, nrow=2 #, scales='free'
#              )+
#   labs(x='change in plant richness', 
#        y ='change in parasite epidemic (diff. in annual AUDPS)')+
#   theme_bw()

# disease_c_tidy%>%
#   ggplot()+
#  # geom_hline(yintercept = 0, lty=2, lwd=1.25, col='red')+
#   geom_point(aes(x=log10(distance), y = abs(sp_rich)), pch=21, size=3)+ 
#   facet_wrap(~Time*Treat,ncol=4, nrow=2 #, scales='free'
#   )+
#   labs(x='compositional host community change (euclidean distance moved by a community)', 
#        y ='change in richness')+
#   theme_bw()
# 
# 
# disease_c_tidy%>%
#   ggplot()+
#   geom_hline(yintercept = 0, lty=2, lwd=1.25, col='red')+
#   geom_point(aes(x=log10(distance), y = sp_rich), pch=21, size=3)+ 
#   facet_wrap(~Time*Treat,ncol=4, nrow=2 #, scales='free'
#   )+
#   labs(x='compositional host community change (euclidean distance moved by a community)', 
#        y ='change in richness')+
#   theme_bw()
```

```{r cross species and host community change}
disease_community_change %>%
  ggplot()+
  geom_hline(yintercept = 0, lty=2, lwd=1)+
  geom_vline(xintercept = 0, lty=2, lwd=1)+
  geom_point(aes(x=sp_rich, y = pathogen, fill=Treat, shape=Time), size=3)+ 
  geom_smooth(aes(x=sp_rich, y = (pathogen), group=Time, color=Treat), size =1.5,  se = FALSE, method='lm') +
  facet_wrap(~Treat,ncol=2, nrow=2 #, scales='free'
  )+
  scale_color_manual(values=c('#fed976','#a1dab4','#41b6c4','#225ea8'))+
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21))) + 
  scale_shape_manual(values=c(21,25)) + 
  labs(x='change in plant richness', 
       y ='change in parasite epidemic (diff. in annual AUDPS)')+
  theme_bw()

disease_community_change %>%
  ggplot()+
  geom_hline(yintercept = 0, lty=2, lwd=1)+
 #geom_vline(xintercept = 0, lty=2, lwd=1)+
  geom_point(aes(x=(distance), y = pathogen, fill=Treat, shape=Time), size=3)+ 
  geom_smooth(aes(x=(distance), y = (pathogen), group=Time, color=Treat), size =1.5,  se = FALSE, method='lm') +
  facet_wrap(~Treat,ncol=2, nrow=2 #, scales='free'
  )+
  scale_color_manual(values=c('#fed976','#a1dab4','#41b6c4','#225ea8'))+
  scale_fill_manual(values=c('#ffffcc','#a1dab4','#41b6c4','#225ea8'),
                    guide=guide_legend(override.aes=list(shape=21))) + 
  scale_shape_manual(values=c(21,25)) + 
  labs(x='change in host community composition (euclidean distance moved by a community)', 
       y ='change in parasite epidemic (diff. in annual AUDPS)')+
  theme_bw()
```

test if they differ
```{r models for change}
a.mod1 <- aov(Anthracnose ~Treat *log10(distance)*Time+Error(Plot/Time), data=disease_community_change )
summary(a.mod1)

r.mod1 <- aov(Rhiz ~Treat *log10(distance)*Time+Error(Plot/Time), data=disease_community_change )
summary(r.mod1)

ru.mod1 <- aov(Rust ~Treat *log10(distance)*Time+Error(Plot/Time), data=disease_community_change )
summary(ru.mod1)
```

ugh temp and precip data

```{r change temp and disease}
climate_sub <- climate_data_durham %>% 
  filter(Year %in% c("2017", "2018", "2019")) %>%
  filter(Month %in% c("May", "June" , "July" , "August", "September", "October", "November"))%>%
  group_by(Month, Year)%>%
  group_by(Month)
 # mutate(pptchange_17 = P_MONTHLY_CALC - P_MONTHLY_CALC[Year == '2017'],
  #       pptchange_18 = P_MONTHLY_CALC - P_MONTHLY_CALC[Year == '2018'],
   #      tempchange_17 = T_MONTHLY_MAX - T_MONTHLY_MAX [Year == '2017'],
    #     tempchange_18 = T_MONTHLY_MAX  - T_MONTHLY_MAX [Year == '2018'])
```

```{r parasite AUDPS over the entire experiment}
# designate months as a factor; and put in order 
# SSE_prevalence_overall$Month = factor(SSE_prevalence_overall$Month, levels = month.name)
# # select target parasite species and months 
# #SSE_prevalence_overall <- SSE_prevalence_overall %>% 
#  # filter(Month %in% c("May", "June" , "July" , "August", "September", "October", "November"))
# 
# # list for loop
# #year_list <- unique(SSE_prevalence_overall$Year) 
# plot_list <- unique(SSE_prevalence_overall$Plot)
# auc_entire_time <- data.frame()
# 
# #for(k in year_list){
#   for (i in plot_list){
# 
#        test <- SSE_prevalence_overall %>% 
#         arrange(Month)%>%
#          arrange(Year) %>%
#         filter(Plot == "3") %>% 
#         mutate(time = seq(1,930, by =30)) %>% 
#         ungroup() %>%
#         dplyr::select(time, Month, prevalence_within_plot)
#  
#       test <- SSE_prevalence_overall %>% 
#         arrange(Year) %>%
#         arrange(Month)%>%
#         filter(Plot == i) %>% 
#         mutate(time = seq(1,930,by=30 )) %>% 
#         ungroup() %>%
#         dplyr::select(time, Month, prevalence_within_plot)
#       
#       AUC <- audps(test$prevalence_within_plot, test$time)
#       auc_test <- data.frame( i,  AUC)
#       auc_entire_time <- rbind(auc_entire_time, auc_test)
# 
#  # }
# }
# 
# col_head <- c( "Plot",  "total_disease")
# colnames(auc_entire_time) <- col_head
# 
# plot_change <- merge(final_temp, auc_entire_time, by ="Plot")
# head(plot_change)
```

```{r three parasite spp entire AUDPS}
# # select target parasite species and months 
# SSE_prevalence_spp3 <- SSE_prevalence_spp %>%
#   filter(parasite %in% c("Anthracnose","CRust", "Rhiz")) #%>%
#  #filter(Month %in% c("May", "June" , "July" , "August", "September", "October", "November"))
# SSE_prevalence_spp3$Month = factor(SSE_prevalence_spp3$Month, levels = month.name)
# 
# # list for loop
# # plot_list <- unique(SSE_prevalence_spp3$Plot)
# parasite_list <- unique(SSE_prevalence_spp3$parasite)
# entire_auc_parasite_spp <- data.frame()
# 
# for (i in plot_list){
#     for (j in parasite_list){
#     
#       #  test <- SSE_prevalence_spp3 %>% 
#       #    arrange (Month) %>%
#       #    arrange(Year)%>%
#       #    filter(Plot == "3") %>% 
#       #    filter(parasite == "Anthracnose") %>% 
#       #    mutate(time = seq(1,930,by=30 )) %>%
#       #    ungroup() %>%
#       #    dplyr::select(time, Month, prevalence_among_plants)
#  
#       test <- SSE_prevalence_spp3 %>% 
#         arrange(Month) %>%
#         arrange(Year)%>%
#         filter(Plot == i) %>% 
#         filter(parasite== j) %>%
#         mutate(time = seq(1,930,by=30 )) %>% 
#         ungroup() %>%
#         dplyr::select(time, Month, prevalence_among_plants)
#       
#       AUC <- audps(test$prevalence_among_plants, test$time)
#       auc_test <- data.frame(i, j, AUC)
#       entire_auc_parasite_spp <- rbind(entire_auc_parasite_spp, auc_test)
#   }
# }
# 
# col_head <- c( "Plot", "parasite", "AUDPS_parasite_spp")
# colnames(entire_auc_parasite_spp) <- col_head
# 
# 
# plot_change_spp <- merge(final_temp, entire_auc_parasite_spp, by ="Plot")
# head(plot_change_spp)
```

```{r disease community change}
# plot_change %>% 
#  # filter(Treat == "C->R->P")%>%
#   ggplot(aes(y= (total_disease), x = log10(distance)))+
#   geom_point(aes(y= (total_disease), x = log10(distance)), pch=21)+ 
#   labs(x="change in plant community composition (log10 euclidean distance 2017-2019)", 
#        y = "total disease (cross-species AUDPS 2017-2019)")+
#  # facet_wrap(~Treat, scales='free')+
#   geom_smooth(method="lm",  se = FALSE, colour='black')+
#   theme_bw()
# 
# #dis.comp.model <- lm (log10(total_disease)~log10(distance)*Treat, data= plot_change)
# #summary(dis.comp.model)
# 
# plot_change_spp %>% 
#   #filter(Treat == "C->R->P")%>%
#   ggplot(aes(y= log10(AUDPS_parasite_spp), x = log10(distance)))+
#   geom_point(aes(y= log10(AUDPS_parasite_spp), x = log10(distance)), pch=21)+ 
#   labs(x="change in plant community composition (log10 euclidean distance 2017-2019)", 
#        y = "total disease (species AUDPS 2017-2019)")+
#   facet_wrap(~parasite*Treat, scales='free')+
#   geom_smooth(method="lm",  se = FALSE, colour='black')+
#   theme_bw()

```

Uses linear combinations of predictors to predict the class of a given observation. Assumes that the predictor variables (p) are normally distributed and the classes have identical variances (for univariate analysis, p = 1) or identical covariance matrices (for multivariate analysis, p > 1)


```{r SEM prep}
#plant_SSE  <- data.frame(plant_SSE)
# checking out covariance
# by hand
#sum((plant_SSE$Anthracnose - mean(plant_SSE$Anthracnose)) * (plant_SSE$Rust - mean(plant_SSE$Rust)))/(length(plant_SSE$Rust) - 1)

# function in R 
#cov(plant_SSE$Anthracnose, plant_SSE$Rust)

#If the units of x are much larger than y, then the covariance will also be large; can use Z transformation to set variables on the same scale; use scale function to do this 
#cov(plant_SSE$Anthracnose, plant_SSE$Rust)
#cor(plant_SSE$Anthracnose, plant_SSE$Rust)

#cov(plant_SSE$Anthracnose, plant_SSE$sp_rich)
#cor(plant_SSE$Anthracnose, plant_SSE$sp_rich)

# If you have a nominal categorical variable with $K > 2$ levels, you need to replace it by a set of $K-1$ dummy variables
# so 4-1; need 3 indicator variables 
# C-R-P is reference
# C-R-P: X(crp) = 0; X(cr-p) = 0; X(control) = 0 
# CRP: X(crp) = 1; X(cr-p) = 0; X(control) = 0 
# CR-P:  X(crp) = 0; X(cr-p) = 1; X(control) = 0 
# Control:  X(crp) = 0; X(cr-p) = 0; X(control) = 1 

#plant_SSE <- plant_SSE %>% select(-(X1))

dummy <-data.frame(Treat = c('C->R->P', 'Control', 'CR->P', 'CRP'), 
                   '1' = c(0,1,0,0),
                   '2' = c(0,0,1,0),
                   '3' = c(0,0,0,1))

#plot(sp_rich~ AUDPS_parasite, data= plant_SSE)
#plant_SSE %>% ggplot()+ geom_point(aes(x=AUDPS_parasite, y = log10(sp_rich)))+facet_wrap(~Year) +theme_bw()
#plant_SSE %>% ggplot()+ geom_point(aes(x=AUDPS_parasite, y = hill_shannon))+facet_wrap(~Year) +theme_bw()
#plant_SSE %>% ggplot()+ geom_point(aes(x=AUDPS_parasite, y = hill_simpson))+facet_wrap(~Year) +theme_bw()

#plant_SSE %>% ggplot()+ geom_point(aes(x=Forbs, y = sp_rich))+facet_wrap(~Year) +theme_bw()
#plant_SSE %>% ggplot()+ geom_point(aes(x=log_biomass, y = sp_rich))+facet_wrap(~Year) +theme_bw()
#plot(Forbs~ AUDPS_parasite, data= plant_SSE)
#plot(log_biomass~ AUDPS_parasite, data= plant_SSE)
#plot(Schedonorus_arundinaceus~AUDPS_parasite, data= plant_SSE)
#plot(Grasses~AUDPS_parasite, data= plant_SSE)

plant_SSE <- merge(plant_SSE, dummy, by =c('Treat'))# %>%  mutate_at(c("X1", "X2", "X3"), as.factor) 
```

The observed effects of fungicide treatment on plant diversity is the product of a series of direct and indirect relationships between pathogens and their hosts. To synthesize these relationships, we constructed structural equation models (SEM) with piecwiseSEM to assess the causal role of pathogens in mediating plant richness. Specifically, we tested whether pathogens are acting as mediators lowering overall biomass and the relative abundance of their hosts (grasses?), which in turn promotes plant diversity. This is one proposed pathway that links pathogens to host diversity, and there may be other links, besides biomass and abundance patterns, driving these observed effects. Thus, we also used a test of direct separation to identify paths that were not initially included in our model (e.g., direct link between fungicide treatment and plant diversity). Based on our prior analyses we hypothesized that the causal structure of our model would vary among years, so each year was modelled separately (or could do a multigroup modelâ€¦ which seems like the same thing?). We compared full and reduced models using AIC and assessed model fit with a Chi-square (X^2) test and AIC. We report standardized path coefficients, which are scaled by their means and standard deviations. 
```{r SEM survey}
richness.model <- '
AUDPS_parasite  ~ X1 + X2 +X3
log_biomass ~ AUDPS_parasite + sp_rich
Grasses ~ AUDPS_parasite + Woody
Forbs ~ AUDPS_parasite + Woody + Grasses
sp_rich ~ log_biomass + AUDPS_parasite + Forbs +Woody + Grasses + Legumes
'
#richness.sem <- sem(richness.model, data=plant_SSE, estimator = "mlm")
#survey.design <- svydesign(ids=~1, strata = ~ Plot, prob =~1, data=na.omit(plant_SSE))
#richness.sem <- lavaan.survey(richness.model, survey.design)
#summary(richness.sem, rsquare=T, standardized = T, fit.measures = T)
```

```{r piecewiseSEM}
library(piecewiseSEM)
library(lavaan)
library(lavaan.survey)
plant_SSE <- plant_SSE %>% mutate(Plot = as.numeric(Plot))

# rich.piece <- psem(
#   lmer(AUDPS_parasite  ~ X1 + X2 +X3+(1|Plot), data=plant_SSE),
#   lmer (log_biomass ~ AUDPS_parasite  + (1|Plot), data=plant_SSE),
#   lmer(Grasses ~ AUDPS_parasite + Woody + (1|Plot), data=plant_SSE),
#   lmer( Forbs ~  Woody + Grasses + (1|Plot), data=plant_SSE),
#   lmer(log10(sp_rich) ~ log_biomass + AUDPS_parasite + Forbs +Woody + Grasses + Legumes + (1|Plot), data=plant_SSE),
#   data= plant_SSE
# )

# rich.piece <- psem(
#   lm(AUDPS_parasite  ~ X1 + X2 +X3, data=plant_SSE),
#   lm (log_biomass ~ AUDPS_parasite, data=plant_SSE),
#   lm(Grasses ~ AUDPS_parasite + Woody , data=plant_SSE),
#   lm( Forbs ~  Woody + Grasses , data=plant_SSE),
#   lm(log10(sp_rich) ~ log_biomass + AUDPS_parasite + Forbs +Woody + Grasses + Legumes, data=plant_SSE),
#   data= plant_SSE
# )

richness.sem <- '
AUDPS_parasite  ~ X1 + X2 +X3
log_biomass ~ AUDPS_parasite + log10(sp_rich)
Grasses ~ AUDPS_parasite + Woody
Forbs ~ AUDPS_parasite + Woody + Grasses
log10(sp_rich) ~ log_biomass + AUDPS_parasite + Forbs +Woody + Grasses + Legumes
'


```


